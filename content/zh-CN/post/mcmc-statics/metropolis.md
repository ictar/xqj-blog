---
title: "Metropolis ç®—æ³•è¯¦è§£ï¼šä»åŸç†åˆ° Python å®ç°"
slug: "metropolis"
date: 2026-01-24
description: "Metropolis ç®—æ³•æ˜¯å¦‚ä½•è§£å†³å½’ä¸€åŒ–å¸¸æ•°éš¾é¢˜çš„ï¼Ÿæœ¬æ–‡è¯¦ç»†è§£æ Metropolis é‡‡æ ·èƒŒåçš„è¯¦ç»†å¹³è¡¡åŸç†ï¼Œå¹¶é€šè¿‡ Python ä»£ç æ¼”ç¤ºéšæœºæ¸¸èµ°åœ¨é«˜ç»´åˆ†å¸ƒä¸­çš„è¡¨ç°ä¸è°ƒå‚æŠ€å·§ã€‚"
summary: "Metropolis ç®—æ³•æ˜¯ MCMC çš„åŸºçŸ³ã€‚æœ¬æ–‡æ·±å…¥æ¢è®¨å…¶åº”å¯¹æœªå½’ä¸€åŒ–æ¦‚ç‡å¯†åº¦çš„ç­–ç•¥ï¼Œä»éšæœºæ¸¸èµ°æœºåˆ¶åˆ°é«˜ç»´ç›¸å…³é«˜æ–¯åˆ†å¸ƒçš„é‡‡æ ·å®æˆ˜ï¼Œæä¾›å®Œæ•´çš„ Python å®ç°ä¸å¯è§†åŒ–åˆ†æã€‚"
toc: true
draft: false
tags: ["MCMC", "Metropolisç®—æ³•", "è’™ç‰¹å¡æ´›æ¨¡æ‹Ÿ", "è´å¶æ–¯ç»Ÿè®¡", "Pythonå®ç°", "éšæœºæ¸¸èµ°"]
keywords: ["Metropolisç®—æ³•", "MCMCé‡‡æ ·", "é©¬å°”å¯å¤«é“¾è’™ç‰¹å¡æ´›", "éšæœºæ¸¸èµ°Metropolis", "å½’ä¸€åŒ–å¸¸æ•°", "æ¥å—æ‹’ç»é‡‡æ ·", "ç»†è‡´å¹³è¡¡"]
---

{{< toc >}}

# æˆ‘ä»¬è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ(The Core Problem)

## 1. æ ¸å¿ƒå›°å¢ƒï¼šæ— æ³•è®¡ç®—çš„ $Z$

åœ¨è´å¶æ–¯ç»Ÿè®¡ã€ç‰©ç†æ¨¡æ‹Ÿå’Œé«˜ç»´è®¡ç®—ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä»ä¸€ä¸ªå¤æ‚çš„æ¦‚ç‡åˆ†å¸ƒ $\pi(x)$ ä¸­è¿›è¡Œé‡‡æ ·ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬é€šå¸¸åªçŸ¥é“è¿™ä¸ªåˆ†å¸ƒçš„â€œå½¢çŠ¶â€ï¼Œå´ä¸çŸ¥é“å®ƒçš„â€œè§„æ¨¡â€ã€‚
- **å·²çŸ¥**ï¼š æœªå½’ä¸€åŒ–çš„å¯†åº¦å‡½æ•° $f(x)$ï¼ˆç›¸å¯¹æƒé‡ï¼‰ã€‚
- **æœªçŸ¥**ï¼š å½’ä¸€åŒ–å¸¸æ•° $Z$ï¼ˆæ€»å’Œæˆ–ç§¯åˆ†ï¼‰ã€‚$$\pi(x) = \frac{f(x)}{Z}, \quad \text{å…¶ä¸­ } Z = \int f(x) dx$$
- **ç—›ç‚¹**ï¼š åœ¨é«˜ç»´ç©ºé—´ä¸­ï¼Œè®¡ç®— $Z$ï¼ˆéå†æ•´ä¸ªç©ºé—´æ±‚å’Œï¼‰æ˜¯è®¡ç®—ä¸Šä¸å¯è¡Œçš„ (Intractable)ã€‚
- **åæœ**ï¼š å› ä¸ºä¸çŸ¥é“ $Z$ï¼Œæˆ‘ä»¬æ— æ³•ç®—å‡ºç»å¯¹æ¦‚ç‡ $\pi(x)$ï¼Œä¼ ç»Ÿçš„ç›´æ¥é‡‡æ ·æ–¹æ³•ï¼ˆå¦‚é€†å˜æ¢æ³•ï¼‰å…¨éƒ¨å¤±æ•ˆã€‚

### å…³äº $\pi$

| åœºæ™¯ | $\pi$ çš„å½¢å¼ | æ•°å­¦åç§° | ç‰©ç†æ„ä¹‰ |
| --- | --- | --- | --- |
| **åŸºç¡€é©¬å°”å¯å¤«é“¾** | å‘é‡  | å¹³ç¨³åˆ†å¸ƒå‘é‡ | å„ä¸ªçŠ¶æ€çš„é•¿æœŸåœç•™æ¦‚ç‡ |
| **Metropolis (MCMC)** | å‡½æ•°  | ç›®æ ‡æ¦‚ç‡å¯†åº¦ | æˆ‘ä»¬å¸Œæœ›é‡‡é›†æ ·æœ¬çš„é‚£ä¸ªâ€œå½¢çŠ¶â€ |

## 2. Metropolis çš„è§£å†³ç­–ç•¥ï¼šç›¸å¯¹æ¯”å€¼æ³•

Metropolis ç®—æ³•çš„æ ¸å¿ƒæ´è§æ˜¯ï¼š**æ—¢ç„¶ $Z$ ç®—ä¸å‡ºæ¥ï¼Œé‚£å°±æ¶ˆæ‰å®ƒã€‚**

å¦‚æœä¸å»è®¡ç®—ç»å¯¹æ¦‚ç‡ï¼Œè€Œæ˜¯æ¯”è¾ƒä¸¤ä¸ªçŠ¶æ€ä¹‹é—´çš„**ç›¸å¯¹æ¦‚ç‡æ¯”å€¼**ï¼Œå¸¸æ•° $Z$ å°±ä¼šåœ¨åˆ†å­åˆ†æ¯ä¸­è‡ªåŠ¨æŠµæ¶ˆï¼š
$$\frac{\pi(x_{\text{new}})}{\pi(x_{\text{old}})} = \frac{f(x_{\text{new}}) / Z}{f(x_{\text{old}}) / Z} = \frac{f(x_{\text{new}})}{f(x_{\text{old}})}$$

è¿™ä½¿å¾—æˆ‘ä»¬åªåˆ©ç”¨**ç›¸å¯¹é«˜ä½**ï¼ˆ$f(x)$çš„æ¯”å€¼ï¼‰å°±èƒ½åˆ¤æ–­ä¸¤ä¸ªçŠ¶æ€çš„ä¼˜åŠ£ï¼Œä»è€Œç»•è¿‡äº†è®¡ç®— $Z$ çš„éš¾é¢˜ã€‚


## 3. è¿æ¥ç‚¹ï¼šä¸ºä»€ä¹ˆè¦ç”¨é©¬å°”å¯å¤«é“¾ï¼Ÿ

æ—¢ç„¶æˆ‘ä»¬åªèƒ½åšâ€œå±€éƒ¨æ¯”è¾ƒâ€ï¼ˆæ¯”è¾ƒå½“å‰ä½ç½®å’Œä¸‹ä¸€æ­¥ä½ç½®ï¼‰ï¼Œæˆ‘ä»¬å°±æ— æ³•ä¸€æ­¥åˆ°ä½åœ°ç”Ÿæˆç‹¬ç«‹æ ·æœ¬ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿ**åœ¨ç©ºé—´ä¸­æ¸¸èµ°**çš„æœºåˆ¶ï¼Œè¿™å°±å¼•å…¥äº†é©¬å°”å¯å¤«é“¾ã€‚

* **åŠ¨æ€æ¨¡æ‹Ÿé™æ€ï¼š** æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å¾—åˆ°ä¸€ä¸ª**é™æ€åˆ†å¸ƒ**  $\pi$ çš„æ ·æœ¬ï¼ŒMetropolis çš„æ‰‹æ®µæ˜¯æ„é€ ä¸€ä¸ª**åŠ¨æ€è¿‡ç¨‹**ï¼ˆé©¬å°”å¯å¤«é“¾ï¼‰ã€‚
* **é€†å‘å·¥ç¨‹æ€ç»´ï¼š**
  * **ä¼ ç»Ÿé©¬å°”å¯å¤«é“¾é—®é¢˜ï¼š** ç»™å®šè½¬ç§»çŸ©é˜µ  $P$ ï¼Œæ±‚ç¨³æ€åˆ†å¸ƒ  $\pi$ ã€‚
  * **Metropolis (MCMC) é—®é¢˜ï¼š** å·²çŸ¥ç›®æ ‡åˆ†å¸ƒ $\pi$ ï¼Œ**è®¾è®¡**ä¸€ä¸ªè½¬ç§»çŸ©é˜µ $P$ï¼Œä½¿å¾—è¿™ä¸ªé“¾æœ€ç»ˆæ”¶æ•›åˆ°  $\pi$ã€‚


* **ç®—æ³•æœ¬è´¨ï¼š**
Metropolis ç®—æ³•é€šè¿‡**ç»†è‡´å¹³è¡¡åŸåˆ™ (Detailed Balance)** æ„é€ äº†ç‰¹æ®Šçš„â€œæ¥å—/æ‹’ç»â€è§„åˆ™ï¼Œå®æ—¶ç”Ÿæˆäº†ä¸€ä¸ª**HIA é“¾**ï¼ˆé½æ¬¡ã€ä¸å¯çº¦ã€éå‘¨æœŸï¼‰ã€‚
* **æœ€ç»ˆç»“è®ºï¼š**
æ ¹æ®**éå†å®šç† (Ergodic Theorem)**ï¼Œè¿™ä¸ªé©¬å°”å¯å¤«é“¾è·‘å‡ºæ¥çš„**è½¨è¿¹ (Trajectory)**ï¼Œåœ¨é•¿æœŸç»Ÿè®¡ä¸Šç­‰ä»·äºä»ç›®æ ‡åˆ†å¸ƒ  $Z$ ä¸­æŠ½å–çš„æ ·æœ¬ã€‚

> **ä¸€å¥è¯æ€»ç»“ï¼š**
> Metropolis ç®—æ³•æ˜¯ä¸ºäº†è§£å†³ **â€œåœ¨å½’ä¸€åŒ–å¸¸æ•° $Z$ æœªçŸ¥çš„æƒ…å†µä¸‹è¿›è¡Œé‡‡æ ·â€** çš„éš¾é¢˜ï¼Œå®ƒé€šè¿‡ **â€œæ„é€ ä¸€ä¸ªä»¥ç›®æ ‡åˆ†å¸ƒä¸ºç¨³æ€çš„é©¬å°”å¯å¤«é“¾â€** æ¥å®ç°è¿™ä¸€ç›®æ ‡ã€‚

# Metropolisï¼ˆéšæœºæ¸¸èµ°ï¼‰

ä¸ºäº†ä¿è¯æ”¶æ•›åˆ° $\pi$ï¼Œæˆ‘ä»¬åªéœ€è¦æ„é€ ä¸€ä¸ªæ»¡è¶³ ç»†è‡´å¹³è¡¡æ–¹ç¨‹ çš„é“¾ï¼š
$$\pi_i P_{ij} = \pi_j P_{ji}$$

Metropolis ç®—æ³•æŠŠè½¬ç§»è¿‡ç¨‹æ‹†æˆäº†ä¸¤æ­¥ï¼š
1. **æè®® (Proposal)** $Q_{ij}$ï¼šæè®®è½¬ç§»æ–¹ç¨‹ã€‚åœ¨æ•°å­¦ç¬¦å·é‡Œï¼Œå®ƒé€šå¸¸å†™ä½œ $Q(x_{new} | x_{old})$ æˆ–è€… $q(x' | x)$ã€‚æ„æ€æ˜¯ï¼šâ€œå·²çŸ¥æˆ‘ç°åœ¨ç«™åœ¨ $x_{old}$ï¼Œæˆ‘ä¸‹ä¸€æ­¥æè®®è·³åˆ° $x_{new}$ çš„æ¦‚ç‡æ˜¯å¤šå°‘ï¼Ÿâ€
   - è¯·æ³¨æ„ï¼Œå®ƒå«â€œæè®®â€ (Proposal)ã€‚å› ä¸ºå®ƒåªæ˜¯è´Ÿè´£å»ºè®®ï¼šâ€œå˜¿ï¼Œæˆ‘ä»¬è¦ä¸è¦è¯•è¯•å»é‚£é‡Œï¼Ÿâ€ è‡³äºåˆ°åº•å»ä¸å»ï¼Œé‚£æ˜¯åé¢ $\alpha$ (æ¥å—ç‡) å†³å®šçš„äº‹ã€‚
   - åœ¨åŸå§‹çš„ Metropolis ç®—æ³•ä¸­ï¼Œ$Q$ å¿…é¡»æ˜¯**å¯¹ç§°çš„ï¼ˆSymmetryï¼‰**ï¼š$$Q(x_{new} | x_{old}) = Q(x_{old} | x_{new})$$
     - è¿™æ ·åœ¨åç»­è®¡ç®—æ¥å—ç‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠ $Q$ æ¶ˆå»äº†ã€‚
   - åœ¨å®è·µæ—¶ï¼Œ$Q$ é€šå¸¸å°±æ˜¯ä¸€è¡Œç®€å•çš„éšæœºæ•°ç”Ÿæˆä»£ç ã€‚å®ƒæœ‰ä¸¤ç§å¸¸è§çš„å½¢æ€
     - A. å‡åŒ€æ¸¸èµ° (Uniform Random Walk)
       - ä»£ç ï¼š  `x_new = x_old + random.uniform(-1, 1)`
       - é€»è¾‘ï¼š ä»¥å½“å‰ä½ç½®ä¸ºä¸­å¿ƒï¼Œç”»ä¸€ä¸ªå®½ä¸º 2 çš„ç›’å­ï¼Œç›’å­é‡Œçš„ä»»ä½•ä¸€ä¸ªç‚¹è¢«é€‰ä¸­çš„æ¦‚ç‡éƒ½ä¸€æ ·ã€‚
       - ç‰¹ç‚¹ï¼š ç®€å•ç²—æš´ã€‚
     - B. é«˜æ–¯æ¸¸èµ° (Gaussian Random Walk)
       - ä»£ç ï¼š  `x_new = x_old + random.normal(0, sigma)`
       - é€»è¾‘ï¼š ä»¥å½“å‰ä½ç½®ä¸ºä¸­å¿ƒï¼Œç”Ÿæˆä¸€ä¸ªæ­£æ€åˆ†å¸ƒã€‚ç¦»å½“å‰ä½ç½®è¶Šè¿‘çš„ç‚¹ï¼Œè¶Šå®¹æ˜“è¢«æè®®ï¼›å¤ªè¿œçš„ç‚¹å¾ˆå°‘è¢«æè®®ã€‚
       - ç‰¹ç‚¹ï¼š æ›´ç¬¦åˆè‡ªç„¶ç•Œçš„ç§»åŠ¨è§„å¾‹ï¼ˆå¤§å¤šæ•°æ—¶å€™è¿ˆå°æ­¥ï¼Œå¶å°”è¿ˆå¤§æ­¥ï¼‰ã€‚
2. **æ¥å— (Acceptance)** $\alpha_{ij}$ï¼š å†³å®šâ€œæˆ‘çœŸçš„è¦è·³è¿‡å»å—ï¼Œè¿˜æ˜¯ç•™åœ¨åŸåœ°ï¼Ÿâ€ã€‚
   - æ¥å—ç‡è™½ç„¶æ˜¯ç”±çŠ¶æ€å¯¹ $(i, j)$ å†³å®šçš„å›ºå®šå€¼ï¼Œä½†åœ¨å·¥ç¨‹ä¸Šï¼Œå› ä¸ºçŠ¶æ€æ•°é‡ $N$ æ˜¯å¤©æ–‡æ•°å­—ï¼Œæˆ‘ä»¬æ°¸è¿œæ— æ³•æŠŠè¿™ä¸ª $N \times N$ çš„è¡¨æ ¼é¢„å…ˆç®—å‡ºæ¥å­˜å‚¨ã€‚æˆ‘ä»¬åªèƒ½ **â€œèµ°åˆ°å“ªï¼Œç®—åˆ°å“ªâ€**ã€‚
   - âš ï¸ Metropolis ç®—æ³•å­˜åœ¨çš„å…¨éƒ¨æ„ä¹‰ï¼Œå°±æ˜¯å› ä¸ºçŠ¶æ€ç©ºé—´å¤ªå¤§ï¼ˆæˆ–è¿ç»­æ— é™ï¼‰ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•æå‰ç¡®å®šè¿™ä¸ªå…³äºæ¥å—ç‡çš„â€œäºŒç»´æ•°ç»„â€ã€‚

æ‰€ä»¥ï¼Œå®é™…çš„è½¬ç§»æ¦‚ç‡æ˜¯ï¼š$P_{ij} = Q_{ij} \times \alpha_{ij}$ï¼ˆæ³¨æ„è¿™é‡Œ $i \ne j$ï¼‰ã€‚æŠŠå®ƒä»£å…¥ç»†è‡´å¹³è¡¡æ–¹ç¨‹ï¼š
$$\pi_i (Q_{ij} \alpha_{ij}) = \pi_j (Q_{ji} \alpha_{ji})$$

å‡è®¾æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯**å¯¹ç§°çš„æè®®è§„åˆ™**ï¼ˆå³ $Q_{ij} = Q_{ji}$ï¼Œæ¯”å¦‚å‘å·¦è·³å’Œå‘å³è·³çš„æ¦‚ç‡ä¸€æ ·ï¼Œéƒ½æ˜¯ 0.5ï¼‰ã€‚é‚£ä¹ˆæ–¹ç¨‹å°±ç®€åŒ–ä¸ºï¼š
$$\pi_i \alpha_{ij} = \pi_j \alpha_{ji}$$
æˆ–è€…å†™æˆæ¯”ç‡ï¼š
$$\frac{\alpha_{ij}}{\alpha_{ji}} = \frac{\pi_j}{\pi_i}$$


## ä¸‰ä¸ªç‰ˆæœ¬çš„æ¥å—ç‡ $\alpha_{ij}$


| ç‰ˆæœ¬ | å…¬å¼æ ¸å¿ƒ | é€‚ç”¨æ€§ | æ•ˆç‡ (Peskunåº) | å¤‡æ³¨ |
| :--- | :--- | :--- | :--- | :--- |
| 1. Metropolis | $\frac{\pi_j}{\pi_i}$ | ä»…å¯¹ç§° $q$ | â­â­â­ (æœ€é«˜) | ç®€å•ç²—æš´ï¼Œåªè¦èƒ½ç”¨å°±ç”¨å®ƒã€‚ |
| 2. Barker | $\frac{\pi_j}{\pi_i + \pi_j}$ | ä»…å¯¹ç§° $q$ | â­ (è¾ƒä½) | ç‰©ç†å­¦åçˆ±ï¼Œæ•°å­¦æ€§è´¨å¥½ï¼ˆå…‰æ»‘ï¼‰ï¼Œä½†æ‹’ç»ç‡é«˜ã€‚ |
| 3. MH | $\frac{\pi_j q_{ji}}{\pi_i q_{ij}}$ | ä»»æ„ $q$ | â­â­â­ (æœ€é«˜) | ç°ä»£ MCMC çš„åŸºçŸ³ï¼Œæ¶µç›–äº†ç¬¬ 1 ç§æƒ…å†µã€‚ |


### ç‰ˆæœ¬ä¸€ï¼šMetropolis é€‰æ‹© (The Metropolis Choice)

å‡è®¾ä½ ç°åœ¨å¤„äºçŠ¶æ€ $i$ï¼Œç³»ç»Ÿå»ºè®®ä½ è·³åˆ°çŠ¶æ€ $j$ã€‚å¦‚æœçŠ¶æ€ $j$ çš„æ¦‚ç‡æ¯”çŠ¶æ€ $i$ æ›´é«˜ï¼ˆå³ $\pi_j > \pi_i$ï¼Œè¿™ä¸€æ­¥æ˜¯å¾€â€œé«˜å¤„â€èµ°ï¼‰ï¼Œä¸ºäº†æ»¡è¶³ä¸Šé¢çš„æ¯”ç‡ï¼Œæ¥å—æ¦‚ç‡ $\alpha_{ij}$ åº”è¯¥è®¾ä¸º 1 (100%) æœ€åˆé€‚ï¼ˆä¹Ÿæœ€æœ‰æ•ˆç‡ï¼‰ã€‚å› ä¸ºæ—¢ç„¶ $\pi_j > \pi_i$ï¼Œè¯´æ˜æ–°çŠ¶æ€ $j$ æ˜¯ä¸€ä¸ªâ€œæ›´å¥½â€æˆ–è€…æ˜¯â€œæ›´é‡è¦â€çš„çŠ¶æ€ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¹æ„å¾€é«˜å¤„èµ°ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯«ä¸çŠ¹è±«åœ°æ¥å—è¿™ä¸ªæè®®ã€‚

è¿™å¾—åˆ°äº†è‘—åçš„ Metropolis æ¥å—å‡†åˆ™ (Acceptance Probability)ï¼š
$$\alpha_{ij} = \min \left( 1, \frac{\pi_j}{\pi_i} \right)$$
å®ƒåŒ…å«äº†ä¸¤ç§æƒ…å†µï¼š
1. å¾€é«˜å¤„èµ° ($\pi_j > \pi_i$)ï¼š æ¯”å€¼ $>1$ï¼Œå– $\min$ åå¾—åˆ° 1ã€‚æ€»æ˜¯æ¥å—ã€‚
2. å¾€ä½å¤„èµ° ($\pi_j < \pi_i$)ï¼š æ¯”å€¼ $<1$ï¼Œå– $\min$ åå¾—åˆ° $\frac{\pi_j}{\pi_i}$ã€‚
   - è¿™æ‰æ˜¯ç®—æ³•çš„çµé­‚ï¼
   - å³ä½¿æ–°çŠ¶æ€ä¸å¦‚ç°åœ¨å¥½ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ä¸€å®šçš„æ¦‚ç‡ï¼ˆè™½ç„¶ä¸æ˜¯ 100%ï¼‰æ¥å—å®ƒã€‚
   - **ä¸ºä»€ä¹ˆï¼Ÿ** ä¸ºäº†é˜²æ­¢é™·å…¥â€œå±€éƒ¨æœ€ä¼˜â€ (Local Optima)ã€‚å¶å°”æ¥å—åç»“æœï¼Œèƒ½è®©ä½ è·³å‡ºå°å‘ï¼Œå»å¯»æ‰¾æ›´è¿œå¤„çš„æœ€é«˜å³°ã€‚

ğŸ” é€‚ç”¨æ¡ä»¶ï¼šæè®®åˆ†å¸ƒå¿…é¡»æ˜¯å¯¹ç§°çš„ï¼Œå³ $q_{ij} = q_{ji}$ï¼ˆä» $i$ è·³åˆ° $j$ çš„æ¦‚ç‡ç­‰äºä» $j$ è·³å› $i$ çš„æ¦‚ç‡ï¼‰ã€‚
- ä¾‹å­ï¼š éšæœºæ¸¸èµ°ï¼Œå‘å·¦ä¸€æ­¥å’Œå‘å³ä¸€æ­¥æ¦‚ç‡ç›¸ç­‰ã€‚

#### è¯æ˜

$$
\pi_ip_{ij} = \pi_iq_{ij}\alpha_{ij} = \pi_iq_{ij}\min \left( 1, \frac{\pi_j}{\pi_i} \right) = q_{ij}\min \left( \pi_i, \pi_j \right) = q_{ij}\min \left( \pi_j, \pi_i \right) = \pi_jq_{ij}\min \left( 1, \frac{\pi_i}{\pi_j} \right) = \pi_jq_{ji}\min \left( 1, \frac{\pi_i}{\pi_j} \right) = \pi_jq_{ji} \alpha_{ji}
$$


#### ä¼˜åŠ£
- âœ… ä¼˜åŠ¿ï¼ˆ**Peskun å®šç†**ï¼‰ï¼š è¿™æ˜¯æ•°å­¦ä¸Š**æœ€ä¼˜**çš„é€‰æ‹©ã€‚Peskun (1973) è¯æ˜äº†ï¼Œåœ¨æ‰€æœ‰æ»¡è¶³ç»†è‡´å¹³è¡¡çš„æ¥å—ç‡å‡½æ•°ä¸­ï¼ŒMetropolis é€‰æ‹©èƒ½ä½¿å¾—ä¼°è®¡é‡çš„æ¸è¿‘æ–¹å·®æœ€å°ã€‚ç®€å•è¯´ï¼šå®ƒæœ€ä¸çˆ±æ‹’ç»äººï¼Œèƒ½åœ¨ä¿æŒå¹³è¡¡çš„å‰æä¸‹æœ€å¤§åŒ–æµåŠ¨æ€§ã€‚
- âŒ åŠ£åŠ¿ï¼š 
  - å—é™ã€‚å¿…é¡»ä¿è¯æè®®åˆ†å¸ƒå¯¹ç§°ï¼Œæ— æ³•å¤„ç†éå¯¹ç§°çš„å¤æ‚æè®®ï¼ˆå¦‚ Log-Normalï¼‰ã€‚
  - ä»è®¡ç®—æœºè®¡ç®—çš„è§’åº¦æ¥è¯´ï¼Œâ€œå¯¹æ¯”æ“ä½œâ€æ•ˆç‡æ›´ä½ã€‚

### ç‰ˆæœ¬ äºŒï¼šBarker é€‰æ‹© (The Barker Choice / Glauber Dynamics)

è¿™ä¸ªç‰ˆæœ¬ç”± Barker (1965) æå‡ºï¼Œåœ¨ç»Ÿè®¡ç‰©ç†ä¸­ï¼ˆç‰¹åˆ«æ˜¯ Ising æ¨¡å‹å’Œè‡ªæ—‹ç»ç’ƒæ¨¡æ‹Ÿï¼‰è¢«ç§°ä¸º Glauber Dynamics æˆ– Heat Bath çš„å˜ä½“ã€‚

$$
\alpha_{ij} = \frac{\pi_i}{\pi_i+\pi_j}
$$

ğŸ” é€‚ç”¨æ¡ä»¶ï¼šåŒæ ·é€šå¸¸ç”¨äº **å¯¹ç§°æè®®**($q_{ij}=q_{ji}$) çš„åœºæ™¯ã€‚å¸¸è§äºç»Ÿè®¡ç‰©ç†ä¸­çš„ Ising æ¨¡å‹ æ¨¡æ‹Ÿï¼ˆä¹Ÿç§°ä¸º Heat Bath ç®—æ³•çš„ä¸€ç§å½¢å¼ï¼‰ã€‚

#### è¯æ˜

åŒæ ·å‡è®¾å¯¹ç§° $q$ï¼Œåªéœ€è¯æ˜ $\pi_i \alpha_{ij} = \pi_j \alpha_{ji}$ã€‚
- å·¦è¾¹ ($i \to j$)ï¼š$$\pi_i \times \frac{\pi_j}{\pi_i + \pi_j} = \frac{\pi_i \pi_j}{\pi_i + \pi_j}$$
- å³è¾¹ ($j \to i$)ï¼š$$\pi_j \times \frac{\pi_i}{\pi_j + \pi_i} = \frac{\pi_j \pi_i}{\pi_i + \pi_j}$$
- ç»“è®ºï¼š åˆ†å­åˆ†æ¯å®Œå…¨ä¸€æ ·ã€‚å¾—è¯ã€‚

#### ä¼˜åŠ£
- âœ… ä¼˜åŠ¿ï¼š**å‡½æ•°å…‰æ»‘**ã€‚$\min(1, x)$ å‡½æ•°åœ¨ 1 å¤„æœ‰ä¸€ä¸ªå°–è§’ï¼ˆä¸å¯å¯¼ï¼‰ï¼Œè€Œ $\frac{x}{1+x}$ æ˜¯ä¸€æ¡å¹³æ»‘çš„ Sigmoid æ›²çº¿ã€‚åœ¨æŸäº›éœ€è¦å¯¹åŠ¨åŠ›å­¦è¿‡ç¨‹æ±‚å¯¼çš„ç†è®ºåˆ†æä¸­ï¼Œè¿™ä¸ªæ€§è´¨éå¸¸é‡è¦ã€‚
- âŒ åŠ£åŠ¿ï¼š æ•ˆç‡è¾ƒä½ã€‚
  - å½“ $\pi_j > \pi_i$ æ—¶ï¼ŒMetropolis ä¼š 100% æ¥å—ã€‚
  - ä½† Barker å³ä½¿é¢å¯¹æ›´å¥½çš„çŠ¶æ€ï¼Œæ¥å—ç‡ä¹Ÿæ°¸è¿œå°äº 1ï¼ˆä¾‹å¦‚ $\pi_j = \pi_i$ æ—¶ï¼ŒMetropolis æ¥å—ç‡æ˜¯ 1ï¼ŒBarker åªæœ‰ 0.5ï¼‰ã€‚è¿™æ„å‘³ç€å®ƒä¼šæ‹’ç»æ›´å¤šçš„å¥½æ ·æœ¬ï¼Œæ”¶æ•›å˜æ…¢ã€‚

### ç‰ˆæœ¬ä¸‰ï¼šMetropolis-Hastings (MH) æ¥å—ç‡

$$
\alpha_{ij} = \min \left(1, \frac{q_{ji}\pi_j}{q_{ij}\pi_i}\right)
$$

ğŸ” é€‚ç”¨æ¡ä»¶:é€šç”¨å®Œå…¨ä½“ã€‚é€‚ç”¨äº**ä»»ä½•æè®®åˆ†å¸ƒ** $q$ï¼Œæ— è®ºæ˜¯å¦å¯¹ç§°ã€‚å®ƒæ˜¯ç¬¬ 1 ç§æƒ…å†µï¼ˆç‰ˆæœ¬ä¸€ï¼‰çš„ä¸€èˆ¬åŒ–å½¢å¼ã€‚

#### æ•°å­¦è¯æ˜
æˆ‘ä»¬è¦è¯æ˜å®Œæ•´å½¢å¼ï¼š$\pi_i q_{ij} \alpha_{ij} = \pi_j q_{ji} \alpha_{ji}$ã€‚

å®šä¹‰æ¥å—ç‡æ¯”å€¼ $R = \frac{\pi_j q_{ji}}{\pi_i q_{ij}}$ã€‚ä¸å¦¨è®¾ $R \ge 1$ï¼ˆå³ $i \to j$ æ˜¯æ›´æœ‰åˆ©æˆ–æ›´å€¾å‘çš„æµåŠ¨æ–¹å‘ï¼‰ï¼š
- å·¦è¾¹ ($i \to j$)ï¼š $\alpha_{ij} = \min(1, R) = 1$ã€‚$$\text{Left} = \pi_i q_{ij}$$
- å³è¾¹ ($j \to i$)ï¼š é€†å‘çš„æ¯”å€¼æ˜¯ $1/R$ï¼Œå› ä¸º $R \ge 1 \implies 1/R \le 1$ï¼Œæ‰€ä»¥ $\alpha_{ji} = 1/R = \frac{\pi_i q_{ij}}{\pi_j q_{ji}}$ã€‚$$\text{Right} = \pi_j q_{ji} \times \left( \frac{\pi_i q_{ij}}{\pi_j q_{ji}} \right)$$æ¶ˆå» $\pi_j q_{ji}$ åï¼š$$\text{Right} = \pi_i q_{ij}$$
- ç»“è®ºï¼š å·¦è¾¹ = å³è¾¹ã€‚å¾—è¯ã€‚

#### ä¼˜åŠ£
- âœ… ä¼˜åŠ¿ï¼š**æå…¶çµæ´»**ã€‚å› ä¸ºå¼•å…¥äº† $q_{ji}/q_{ij}$ è¿™ä¸ªHastings ä¿®æ­£é¡¹ï¼Œä½ å¯ä»¥è®¾è®¡ä»»ä½•ä½ å–œæ¬¢çš„æè®®åˆ†å¸ƒï¼ˆæ¯”å¦‚ Log-Normal, MALA, ç”šè‡³ç¥ç»ç½‘ç»œç”Ÿæˆçš„åˆ†å¸ƒï¼‰ï¼Œåªè¦èƒ½è®¡ç®—å‡ºæ¦‚ç‡å¯†åº¦å³å¯ã€‚å®ƒè§£å†³äº†è¾¹ç•Œé—®é¢˜å’Œé«˜ç»´å¼•å¯¼é—®é¢˜ã€‚
- âŒ åŠ£åŠ¿ï¼š è®¡ç®—ç•¥ç¹çã€‚æ¯æ¬¡è¿­ä»£éƒ½éœ€è¦è®¡ç®— $q$ çš„æ¯”å€¼ã€‚å¦‚æœ $q$ å‡½æ•°å¾ˆå¤æ‚ï¼Œè®¡ç®—æˆæœ¬ä¼šå¢åŠ ã€‚

## ç®—æ³•æµç¨‹

### ç¦»æ•£ Metropolis ç®—æ³•

1. å®šä¹‰ä¸å‡è®¾
   - **çŠ¶æ€ç©ºé—´ (State Space)**ï¼š$S = \{s_1, s_2, \dots, s_n\}$ï¼Œæ˜¯ä¸€ä¸ªæœ‰é™ç¦»æ•£é›†åˆã€‚
   - ç›®æ ‡åˆ†å¸ƒ (Target Distribution)ï¼š$\pi = (\pi_1, \pi_2, \dots, \pi_n)$ï¼Œæ»¡è¶³ $\sum \pi_i = 1$ã€‚
     - è¿™æ˜¯ä¸€ä¸ªæé™ç¨³å®šçš„åˆ†å¸ƒã€‚
   - æè®®çŸ©é˜µ (Proposal Matrix)ï¼š$Q = (q_{ij})$ï¼Œå…¶ä¸­ $q_{ij} = P(X^* = s_j | X_t = s_i)$ã€‚
     - å¯¹ç§°æ€§è¦æ±‚ï¼š$q_{ij} = q_{ji}, \forall i, j$ã€‚
   - å½“å‰çŠ¶æ€ï¼šè®¾ $X_t = s_i$ã€‚
2. è½¬ç§»ç®—æ³•æ­¥éª¤ï¼šåœ¨æ¯ä¸€æ—¶åˆ» $t$ï¼Œè½¬ç§»åˆ° $t+1$ çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š
   1. **æè®®é˜¶æ®µ (Proposal Phase)**ï¼š
      1. ç”Ÿæˆéšæœºå˜é‡ $U_1 \sim \text{Uniform}(0, 1)$ã€‚
      2. æ ¹æ® $Q$ çŸ©é˜µçš„ç¬¬ $i$ è¡Œç¦»æ•£åˆ†å¸ƒç¡®å®šå€™é€‰çŠ¶æ€ $s_j$ã€‚å…·ä½“åœ°ï¼Œæ‰¾åˆ° $j$ ä½¿å¾—ï¼š$$\sum_{k=1}^{j-1} q_{ik} \le U_1 < \sum_{k=1}^{j} q_{ik}$$
   2. **æ¥å—é˜¶æ®µ (Acceptance Phase)**ï¼š
      1. è®¡ç®—æ¥å—æ¦‚ç‡ $\alpha_{ij} = \min \left( 1, \frac{\pi_j}{\pi_i} \right)$ã€‚
      2. ç”Ÿæˆéšæœºå˜é‡ $U_2 \sim \text{Uniform}(0, 1)$ã€‚
      3. æ›´æ–°çŠ¶æ€ï¼š$$X_{t+1} = \begin{cases} s_j & \text{è‹¥ } U_2 \le \alpha_{ij} \quad (\text{æ¥å—}) \\ s_i & \text{è‹¥ } U_2 > \alpha_{ij} \quad (\text{æ‹’ç»}) \end{cases}$$
         - æ³¨æ„ï¼Œå½“ $\pi_j \lt \pi_i$ æ—¶ï¼Œ$\alpha_{ij}=1$ï¼Œè¿™ä¸ªæ—¶å€™æ€»æ˜¯æ¥å—çš„ã€‚

#### ç¤ºä¾‹

**è®¾å®šåœºæ™¯**
- çŠ¶æ€ç©ºé—´ï¼š$S = \{1, 2, 3\}$ã€‚
- ç›®æ ‡åˆ†å¸ƒï¼š$\pi = (0.2, 0.5, 0.3)$ã€‚
- æè®®çŸ©é˜µ $Q$ï¼ˆè®¾å®šä¸ºä¸€ä¸ªå¯¹ç§°çš„è½¬ç§»çŸ©é˜µï¼Œæ¯ä¸ªçŠ¶æ€æœ‰ç›¸ç­‰çš„æ¦‚ç‡è·³å‘ä»»æ„çŠ¶æ€ï¼ŒåŒ…æ‹¬è‡ªèº«ï¼‰ï¼š$$Q = \begin{pmatrix} 1/3 & 1/3 & 1/3 \\ 1/3 & 1/3 & 1/3 \\ 1/3 & 1/3 & 1/3 \end{pmatrix}$$

**å•æ­¥è½¬ç§»æ‰‹ç®—è¿‡ç¨‹ï¼š**

å‡è®¾å½“å‰çŠ¶æ€ $X_t = 1$ã€‚

1. ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆæè®®çŠ¶æ€
   - ç”Ÿæˆéšæœºæ•° $U_1 = 0.72$ã€‚
   - æŸ¥çœ‹ $Q$ çš„ç¬¬ 1 è¡Œç´¯ç§¯åˆ†å¸ƒï¼š$[0, 1/3, 2/3, 1]$ã€‚
   - ç”±äº $2/3 \le 0.72 < 1$ï¼Œè½åœ¨ç¬¬ä¸‰ä¸ªåŒºé—´ã€‚
   - å€™é€‰çŠ¶æ€ç¡®å®šï¼š$s_j = 3$ã€‚
2. ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¥å—ç‡
   - æˆ‘ä»¬è¦ä»çŠ¶æ€ 1 è·³å¾€çŠ¶æ€ 3ã€‚
   - $\alpha_{13} = \min \left( 1, \frac{\pi_3}{\pi_1} \right) = \min \left( 1, \frac{0.3}{0.2} \right) = 1$ã€‚
3. ç¬¬ä¸‰æ­¥ï¼šå†³å®šæœ€ç»ˆçŠ¶æ€
   - ç”Ÿæˆéšæœºæ•° $U_2 = 0.45$ã€‚
   - ç”±äº $U_2 \le \alpha_{13}$ (å³ $0.45 \le 1$)ï¼Œ**æ¥å—æè®®**ã€‚
     - âš ï¸ äº‹å®ä¸Šï¼Œè¿™é‡Œå› ä¸º $\alpha_{13} == 1$ï¼Œæ‰€ä»¥æˆ‘ä»¬æ€»æ˜¯æ¥å—ã€‚
   - ç»“æœï¼š$X_{t+1} = 3$ã€‚

å†èµ°ä¸€æ­¥ï¼šå‡è®¾å½“å‰ $X_{t+1} = 3$
1. ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆæè®®çŠ¶æ€
   - ç”Ÿæˆéšæœºæ•° $U_1 = 0.15$ã€‚æŸ¥
   - çœ‹ $Q$ çš„ç¬¬ 3 è¡Œç´¯ç§¯åˆ†å¸ƒï¼š$[0, 1/3, 2/3, 1]$ã€‚
   - ç”±äº $0 \le 0.15 < 1/3$ï¼Œè½åœ¨ç¬¬ä¸€ä¸ªåŒºé—´ã€‚
   - å€™é€‰çŠ¶æ€ç¡®å®šï¼š$s_j = 1$ã€‚
2. ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¥å—ç‡
   - æˆ‘ä»¬è¦ä»çŠ¶æ€ 3 è·³å¾€çŠ¶æ€ 1ã€‚
   - $\alpha_{31} = \min \left( 1, \frac{\pi_1}{\pi_3} \right) = \min \left( 1, \frac{0.2}{0.3} \right) = 0.6667$ã€‚
3. ç¬¬ä¸‰æ­¥ï¼šå†³å®šæœ€ç»ˆçŠ¶æ€
   - ç”Ÿæˆéšæœºæ•° $U_2 = 0.82$ã€‚
   - ç”±äº $U_2 > \alpha_{31}$ (å³ $0.82 > 0.6667$)ï¼Œ**æ‹’ç»æè®®**ã€‚
   - ç»“æœï¼š$X_{t+2} = X_{t+1} = 3$ã€‚


```python
import numpy as np
import matplotlib.pyplot as plt

# --- 1. å‚æ•°è®¾ç½® ---
# ç›®æ ‡åˆ†å¸ƒ pi (å²›A: 0.2, å²›B: 0.5, å²›C: 0.3)
pi = np.array([0.2, 0.5, 0.3])
states_map = {0: 'Island A (0.2)', 1: 'Island B (0.5)', 2: 'Island C (0.3)'}

# æè®®çŸ©é˜µ Q (å¯¹ç§°ï¼Œå‡åŒ€è·³è·ƒ)
# Q[i][j] ä»£è¡¨ä» i æè®®å» j çš„æ¦‚ç‡
Q = np.array([
    [1/3, 1/3, 1/3],
    [1/3, 1/3, 1/3],
    [1/3, 1/3, 1/3]
])

def discrete_metropolis(n_iter, initial_state):
    samples = []
    current_state = initial_state
    
    # é¢„è®¡ç®— Q çš„ç´¯ç§¯åˆ†å¸ƒï¼Œç”¨äº U1 çš„åˆ†ä½æ•°æŸ¥æ‰¾
    Q_cumsum = np.cumsum(Q, axis=1)
    
    for t in range(n_iter):
        # --- ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆæè®® (U1) ---
        u1 = np.random.uniform(0, 1)
        # æ ¹æ® Q çš„å½“å‰è¡Œç´¯ç§¯æ¦‚ç‡ç¡®å®šå€™é€‰çŠ¶æ€ j
        # å¯¹åº”æ•°å­¦å…¬å¼ï¼šsum(q_ik) < u1 <= sum(q_ik)
        proposed_state = np.searchsorted(Q_cumsum[current_state], u1) # é€†å˜æ¢é‡‡æ · (Inverse Transform Sampling) çš„ç¦»æ•£å®ç°
        
        # --- ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¥å—ç‡ alpha ---
        # è¿™é‡Œçš„ pi_j / pi_i
        alpha = min(1, pi[proposed_state] / pi[current_state])
        
        # --- ç¬¬ä¸‰æ­¥ï¼šåˆ¤å®šæ˜¯å¦è½¬ç§» (U2) ---
        u2 = np.random.uniform(0, 1)
        if u2 <= alpha:
            # æ¥å—æè®®
            current_state = proposed_state
        else:
            # æ‹’ç»æè®®ï¼ŒçŠ¶æ€ä¿æŒä¸å˜
            pass
            
        samples.append(current_state)
        
    return np.array(samples)

# --- 2. è¿è¡Œæ¨¡æ‹Ÿ ---
N = 5000  # è¿­ä»£æ¬¡æ•°
samples = discrete_metropolis(N, initial_state=0)

# --- 3. å¯è§†åŒ–å±•ç¤º ---
plt.figure(figsize=(15, 10))

# å›¾ 1: è½¨è¿¹å›¾ (Trace Plot) - åªçœ‹å‰ 100 æ­¥
# è¿™è®©æˆ‘ä»¬çœ‹åˆ°å…·ä½“çš„â€œè·³è·ƒâ€åŠ¨ä½œ
plt.subplot(2, 2, 1)
plt.step(range(100), samples[:100], where='mid', color='blue', linewidth=1.5)
plt.yticks([0, 1, 2], [states_map[0], states_map[1], states_map[2]])
plt.title("1. Trace Plot (First 100 Steps)\nWatch the jumper move!", fontsize=12)
plt.grid(True, axis='y', linestyle='--', alpha=0.5)
plt.xlabel("Step")

# å›¾ 2: æ”¶æ•›å›¾ (Convergence of Frequencies)
# å±•ç¤ºé¢‘ç‡æ˜¯å¦‚ä½•éšæ—¶é—´é€¼è¿‘çœŸå®æ¦‚ç‡çš„
plt.subplot(2, 2, 2)
# è®¡ç®—åŠ¨æ€é¢‘ç‡
iterations = np.arange(1, N + 1)
prob_0 = np.cumsum(samples == 0) / iterations
prob_1 = np.cumsum(samples == 1) / iterations
prob_2 = np.cumsum(samples == 2) / iterations

plt.plot(prob_0, label='Simulated A', color='red', alpha=0.6)
plt.plot(prob_1, label='Simulated B', color='green', alpha=0.6)
plt.plot(prob_2, label='Simulated C', color='blue', alpha=0.6)
# ç”»å‡ºç†è®ºæ¨ªçº¿
plt.axhline(pi[0], color='red', linestyle='--', label='True A (0.2)')
plt.axhline(pi[1], color='green', linestyle='--', label='True B (0.5)')
plt.axhline(pi[2], color='blue', linestyle='--', label='True C (0.3)')

plt.title("2. Convergence Plot\nLaw of Large Numbers in action", fontsize=12)
plt.xlabel("Iterations")
plt.ylabel("Estimated Probability")
plt.legend()
plt.grid(True, alpha=0.3)

# å›¾ 3: æœ€ç»ˆç›´æ–¹å›¾ vs ç†è®ºåˆ†å¸ƒ
plt.subplot(2, 1, 2)
counts = np.bincount(samples, minlength=3)
freqs = counts / N
x_pos = [0, 1, 2]

# ç”»æŸ±çŠ¶å›¾
plt.bar(x_pos, freqs, width=0.4, label='Simulation', color='gray', alpha=0.7)
# ç”»ç†è®ºç‚¹
plt.plot(x_pos, pi, 'ro', markersize=10, label='Theoretical Target', linestyle='None')
# æ·»åŠ æ ‡ç­¾
for i, v in enumerate(freqs):
    plt.text(i, v + 0.01, f"{v:.3f}", ha='center', fontweight='bold')

plt.xticks(x_pos, [states_map[0], states_map[1], states_map[2]])
plt.ylim(0, 0.6)
plt.title(f"3. Final Distribution (N={N})\nDid we match the target?", fontsize=12)
plt.legend()

plt.tight_layout()
plt.show()
```


    
![png](/img/contents/post/mcmc-statics/6_metropolis/6_mcmc_metropolis_5_0.png)
    


1. å·¦ä¸Šå›¾ï¼šè·³è·ƒçš„ç»†èŠ‚ (Trace Plot)
   - è¿™å¼ å›¾å±•ç¤ºäº†ç®—æ³•çš„å‰ 100 æ­¥ã€‚
   - ç›´çº¿éƒ¨åˆ†ï¼š ä½ ä¼šçœ‹åˆ°æœ‰æ—¶å€™çº¿æ¡ä¼šåœ¨æŸä¸€ä¸ªæ°´å¹³é«˜åº¦ï¼ˆæ¯”å¦‚ Island Bï¼‰ä¿æŒå¥½å‡ æ­¥ï¼Œå½¢æˆä¸€æ¡æ¨ªçº¿ã€‚
   - æ•°å­¦å«ä¹‰ï¼š è¿™å°±æ˜¯ **æ‹’ç» (Rejection)**ï¼
     - å½“å°äººåœ¨ B å²›ï¼Œæè®®å» A å²›ï¼ˆ$0.2/0.5$ åªæœ‰ 40% æ¦‚ç‡æ¥å—ï¼‰ã€‚
     - éšæœºæ•° $U_2 > 0.4$ï¼Œæ‹’ç»ï¼å°äººç•™åœ¨ Bã€‚
     - å…³é”®ç‚¹ï¼š è™½ç„¶ä½ç½®æ²¡å˜ï¼Œä½†åœ¨æ•°å­¦ä¸Šï¼Œè¿™ç®—ä½œâ€œæˆ‘ä»¬åœ¨ B åˆé‡‡æ ·äº†ä¸€æ¬¡â€ã€‚è¿™æ­£æ˜¯ä¸ºä»€ä¹ˆ B çš„æ¦‚ç‡ä¼šæ¯” A é«˜çš„åŸå› â€”â€”å› ä¸ºæ˜“è¿›éš¾å‡ºã€‚
2. å³ä¸Šå›¾ï¼šå¤§æ•°å®šå¾‹çš„é­”æ³• (Convergence)
   - è¿™å¼ å›¾å±•ç¤ºäº†éšç€æ­¥æ•° $N$ å¢åŠ ï¼Œæ¯ä¸ªå²›çš„ç»Ÿè®¡é¢‘ç‡æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚
   - åˆæœŸ (0-500æ­¥)ï¼š çº¿æ¡æ³¢åŠ¨å¾ˆå¤§ï¼Œå¾ˆä¸ç¨³å®šã€‚
   - åæœŸ (2000æ­¥ä»¥å)ï¼š çº¿æ¡é€æ¸å˜å¹³ï¼Œæ­»æ­»åœ°è´´åœ¨è™šçº¿ï¼ˆç†è®ºå€¼ï¼‰ä¸Šã€‚
   - æ•°å­¦å«ä¹‰ï¼š è¿™å°±æ˜¯ **éå†æ€§ (Ergodicity)**ã€‚åªè¦æ—¶é—´è¶³å¤Ÿé•¿ï¼Œè®¿é—®é¢‘ç‡ä¸€å®šæ”¶æ•›äº $\pi$ã€‚
3. ä¸‹å›¾ï¼šæœ€ç»ˆæˆç»©å• (Comparison)
   - ç°è‰²çš„æŸ±å­æ˜¯æ¨¡æ‹Ÿå‡ºæ¥çš„ç»“æœã€‚
   - çº¢è‰²çš„åœ†ç‚¹æ˜¯å®šä¹‰çš„ç›®æ ‡åˆ†å¸ƒ $\pi$ ã€‚
   - ç»“æœï¼š åº”è¯¥å‡ ä¹å®Œå…¨é‡åˆã€‚

### è¿ç»­ Metropolis ç®—æ³•

**å®šä¹‰ä¸å‡è®¾**
- $q(x, y)$ æˆ–è€… $K(x, y)$ (æè®®æ ¸): è¿™æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚
    - å«ä¹‰ï¼šç»™å®šå½“å‰ä½ç½® $x$ï¼Œæè®®è·³åˆ° $y$ çš„æ¦‚ç‡å¯†åº¦ã€‚å®ƒå¯¹æ ‡ç¦»æ•£ç¦»æ•£åœºæ™¯ä¸‹çš„ $Q$ï¼Œå› ä¸ºåœ¨è¿ç»­ç©ºé—´ä¸­ï¼ŒçŠ¶æ€æ˜¯æ— é™çš„ï¼Œæˆ‘ä»¬æ²¡æ³•ç”¨çŸ©é˜µæ¥è¡¨ç¤ºã€‚
    - æœ€è‘—åçš„ä¾‹å­æ˜¯ **é«˜æ–¯æ ¸ (Gaussian Kernel)**ï¼š$$q(y|x) = \frac{1}{\sqrt{2\pi\sigma^2}} \exp\left( -\frac{(y-x)^2}{2\sigma^2} \right)$$
    - ç›´è§‚ç†è§£ï¼š è¿™å°±åƒä»¥ $x$ ä¸ºä¸­å¿ƒçš„ä¸€ä¸ªâ€œé’Ÿå½¢åœŸåŒ…â€ã€‚ç¦» $x$ è¶Šè¿‘çš„åœ°æ–¹ï¼Œè¢«é€‰ä¸º $y$ çš„æ¦‚ç‡è¶Šé«˜ã€‚è¿™å…¶å®å°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„ np.random.normal(x, sigma) çš„æ•°å­¦æœ¬è´¨ã€‚
- $\pi(x)$ (ç›®æ ‡): ç›®æ ‡åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦å‡½æ•° (PDF)ã€‚


**ç®—æ³•æ­¥éª¤ (Algorithm Steps):** åœ¨æ—¶åˆ» $t$ï¼Œå½“å‰çŠ¶æ€ä¸º $X_t = x$ï¼š
1. æè®®é˜¶æ®µ (Proposal):
   - ä»æè®®æ ¸ $q(\cdot | x)$ ä¸­ç”Ÿæˆä¸€ä¸ªå€™é€‰ç‚¹ $x^*$ã€‚
   - ä»£ç å®ç°ï¼š `x_star = x + np.random.normal(0, sigma)` (å¦‚æœç”¨é«˜æ–¯æ ¸)ã€‚
2. æ¥å—é˜¶æ®µ (Acceptance):
   - è®¡ç®—æ¥å—ç‡ (è¿™é‡Œå‡è®¾å¯¹ç§°æ ¸ $q(x,y)=q(y,x)$ï¼Œå¦‚é«˜æ–¯æ ¸)ï¼š$$\alpha(x, x^*) = \min\left(1, \frac{\pi(x^*)}{\pi(x)}\right)$$
   - ç”Ÿæˆ $U \sim \text{Uniform}(0, 1)$ã€‚
3. å†³ç­–é˜¶æ®µ (Update):
$$
X_{t+1} = \begin{cases}
x^* & \text{è‹¥ } U \le \alpha(x, x^*) \\
x & \text{è‹¥ } U \> \alpha(x, x^*)
\end{cases}
$$

#### ç¤ºä¾‹

åœ°å½¢æè¿°ï¼šæœ‰ä¸¤åº§å±±å³°ã€‚
- ä¸»å³°åœ¨ $x=2$ã€‚
- æ¬¡å³°åœ¨ $x=-2$ã€‚
- ä¸­é—´éš”ç€æ·±è°·ã€‚

æŒ‘æˆ˜ï¼šå¦‚æœæˆ‘ä»¬ç”¨çš„ Proposal Kernel (é«˜æ–¯æ ¸) çš„æ–¹å·® $\sigma$ å¤ªå°ï¼ˆæ­¥å­å¤ªå°ï¼‰ï¼Œå°äººå¯èƒ½ä¼šè¢«å›°åœ¨å…¶ä¸­ä¸€åº§å±±å¤´ï¼Œè·³ä¸è¿‡å³¡è°·ï¼ˆå±€éƒ¨æœ€ä¼˜é™·é˜±ï¼‰ã€‚


```python
import numpy as np
import matplotlib.pyplot as plt

# --- 1. å®šä¹‰ç›®æ ‡åˆ†å¸ƒ (åŒå³°) ---
# è¿™æ˜¯ä¸€ä¸ªéå½’ä¸€åŒ–çš„å¯†åº¦å‡½æ•° (Unnormalized PDF)
# å³° 1: Mean=-2, Std=0.5
# å³° 2: Mean= 2, Std=0.5
def target_pdf(x):
    p1 = np.exp(- (x + 2)**2 / (2 * 0.5**2))
    p2 = np.exp(- (x - 2)**2 / (2 * 0.5**2))
    return p1 + p2  # åŒå³°å åŠ 

# --- 2. å®šä¹‰æè®®æ ¸ (Proposal Kernel) ---
# è¿™é‡Œä½¿ç”¨å¯¹ç§°çš„é«˜æ–¯æ ¸: q(y|x) ~ N(x, sigma^2)
def sample_proposal_kernel(current_x, sigma):
    return np.random.normal(current_x, sigma)

# --- 3. è¿ç»­ Metropolis ç®—æ³• ---
def continuous_metropolis(n_iter, start_x, sigma):
    samples = []
    current_x = start_x
    accepted_count = 0
    
    for _ in range(n_iter):
        # A. ä»æ ¸ä¸­é‡‡æ · (Proposal)
        x_star = sample_proposal_kernel(current_x, sigma)
        
        # B. è®¡ç®—æ¥å—ç‡ (Symmetric Metropolis)
        # alpha = min(1, pi(new) / pi(old))
        p_new = target_pdf(x_star)
        p_old = target_pdf(current_x)
        
        alpha = min(1, p_new / p_old)
        
        # C. å†³ç­– (Decision)
        u = np.random.uniform(0, 1)
        if u <= alpha:
            current_x = x_star
            accepted_count += 1
            
        samples.append(current_x)
        
    return np.array(samples), accepted_count / n_iter

# --- 4. è¿è¡Œæ¨¡æ‹Ÿ ---
N = 10000
start_x = 0.0  # ä»å³¡è°·ä¸­é—´å¼€å§‹

# å®éªŒ A: çª„æ ¸ (å°æ­¥é•¿) - å¯èƒ½ä¼šè¢«å›°ä½
samples_narrow, acc_narrow = continuous_metropolis(N, start_x, sigma=0.2)

# å®éªŒ B: å®½æ ¸ (é€‚ä¸­æ­¥é•¿) - èƒ½è·¨è¶Šå³¡è°·
samples_wide, acc_wide = continuous_metropolis(N, start_x, sigma=1.5)

# --- 5. å¯è§†åŒ–å¯¹æ¯” ---
plt.figure(figsize=(14, 8))
x_axis = np.linspace(-6, 6, 1000)
y_truth = target_pdf(x_axis)
# ç®€å•å½’ä¸€åŒ–ä¸€ä¸‹ç”¨äºç”»å›¾å¯¹æ¯”
y_truth /= np.trapezoid(y_truth, x_axis)

# å›¾ 1: çª„æ ¸ (Sigma=0.2)
plt.subplot(2, 2, 1)
plt.plot(samples_narrow, color='orange', alpha=0.7, lw=0.5)
plt.title(f"A. Narrow Kernel (sigma=0.2)\nAcc Rate: {acc_narrow:.1%}")
plt.ylabel("Position x")
plt.grid(alpha=0.3)

plt.subplot(2, 2, 3)
plt.hist(samples_narrow, bins=50, density=True, color='orange', alpha=0.5, label='Samples')
plt.plot(x_axis, y_truth, 'r-', lw=2, label='Target')
plt.title("Distribution (Trapped in one peak?)")
plt.legend()

# å›¾ 2: å®½æ ¸ (Sigma=1.5)
plt.subplot(2, 2, 2)
plt.plot(samples_wide, color='green', alpha=0.7, lw=0.5)
plt.title(f"B. Wide Kernel (sigma=1.5)\nAcc Rate: {acc_wide:.1%}")
plt.ylabel("Position x")
plt.grid(alpha=0.3)

plt.subplot(2, 2, 4)
plt.hist(samples_wide, bins=50, density=True, color='green', alpha=0.5, label='Samples')
plt.plot(x_axis, y_truth, 'r-', lw=2, label='Target')
plt.title("Distribution (Good Mixing)")
plt.legend()

plt.tight_layout()
plt.show()
```


    
![png](/img/contents/post/mcmc-statics/6_metropolis/6_mcmc_metropolis_9_0.png)
    


ç»“æœè§£æï¼š
1. çª„æ ¸ (Narrow Kernel, $\sigma=0.2$)
   - è½¨è¿¹å›¾ (å·¦ä¸Š): ä½ å¯èƒ½ä¼šçœ‹åˆ°å°äººä¸€ç›´å¾…åœ¨ $x=0$ é™„è¿‘ï¼Œæˆ–è€…ä¸€æ—¦æ»‘å…¥å·¦è¾¹çš„å±±è°·ï¼ˆ$x=-2$ï¼‰ï¼Œå°±å†ä¹Ÿè·³ä¸åˆ°å³è¾¹çš„å±±è°·ï¼ˆ$x=2$ï¼‰äº†ã€‚
   - åˆ†å¸ƒå›¾ (å·¦ä¸‹): ç›´æ–¹å›¾å¯èƒ½åªæœ‰å•å³°ã€‚
   - æ•°å­¦è§£é‡Š: é«˜æ–¯æ ¸çš„å°¾å·´å¤ªç»†äº†ã€‚è¦ä» $-2$ è·³åˆ° $2$ï¼Œè·ç¦»æ˜¯ 4ã€‚å¯¹äº $\sigma=0.2$ çš„é«˜æ–¯åˆ†å¸ƒæ¥è¯´ï¼Œè·³å‡º $4\sigma$ ä»¥å¤–çš„æ¦‚ç‡å¾®ä¹å…¶å¾®ã€‚
2. å®½æ ¸ (Wide Kernel, $\sigma=1.5$)
   - è½¨è¿¹å›¾ (å³ä¸Š): ä½ ä¼šçœ‹åˆ°å°äººåœ¨ $-2$ å’Œ $2$ ä¹‹é—´åå¤æ¨ªè·³ã€‚
   - åˆ†å¸ƒå›¾ (å³ä¸‹): å®Œç¾å¤ç°äº†åŒå³°ç»“æ„ã€‚
   - æ•°å­¦è§£é‡Š: æ­¤æ—¶çš„é«˜æ–¯æ ¸è¶³å¤Ÿå®½ï¼Œä½¿å¾—ä»ä¸€ä¸ªå±±å¤´â€œæ¢â€åˆ°å¦ä¸€ä¸ªå±±å¤´çš„æ¦‚ç‡å˜å¾—å¯è§‚ï¼Œä»è€Œå®ç°äº†å…¨å±€éå†ã€‚


## $Q$ çš„é€‰æ‹©
åœ¨ Metropolis ç®—æ³•ï¼ˆå¯¹ç§°æè®®ï¼‰çš„æ¡†æ¶ä¸‹ï¼Œé€‰æ‹© $Q$ ä¸»è¦æœ‰ä¸‰ä¸ªç»´åº¦çš„è€ƒé‡ï¼šå°ºåº¦ (Scale)ã€å½¢çŠ¶ (Shape) å’Œ æ–¹å‘ (Orientation)ã€‚

### å°ºåº¦ (Scale)ï¼šæ­¥å­è¯¥è¿ˆå¤šå¤§ï¼Ÿ

è¿™æ˜¯æœ€åŸºç¡€çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸Šä¸€ä¸ªä»£ç ä¸­çœ‹åˆ°çš„ sigmaã€‚
- è¿‡å° ($\sigma \ll$ ç›®æ ‡å®½åº¦)ï¼š
  - ç°è±¡ï¼šæ¥å—ç‡æé«˜ï¼ˆæ¥è¿‘ 100%ï¼‰ï¼Œä½†è½¨è¿¹åƒçˆ¬è¡Œçš„èœ—ç‰›ã€‚
  - æœ¯è¯­ï¼š**éšæœºæ¸¸èµ°è¡Œä¸º (Random Walk Behavior)**ã€‚
  - ä»£ä»·ï¼šä½ éœ€è¦ $N^2$ æ­¥æ‰èƒ½èµ°è¿‡è·ç¦» $N$ã€‚
- è¿‡å¤§ ($\sigma \gg$ ç›®æ ‡å®½åº¦)ï¼š
  - ç°è±¡ï¼šæ¥å—ç‡æä½ï¼ˆæ¥è¿‘ 0%ï¼‰ï¼Œè½¨è¿¹åƒå¿ƒç”µå›¾åœæã€‚
  - åŸå› ï¼šä½ æ€»æ˜¯è¯•å›¾ä»é«˜æ¦‚ç‡åŒºè·³åˆ°æä½æ¦‚ç‡åŒºï¼ˆè’é‡ï¼‰ï¼Œç„¶åè¢«æ‹’ç»ã€‚
- é»„é‡‘æ ‡å‡† (Goldilocks Zone)ï¼š
  - å¯¹äºé«˜ç»´é«˜æ–¯ç›®æ ‡åˆ†å¸ƒï¼Œç†è®ºè¯æ˜æœ€ä½³æ¥å—ç‡çº¦ä¸º 23.4% ($0.234$)ã€‚
  - å¯¹äº 1 ç»´é—®é¢˜ï¼Œé€šå¸¸åœ¨ 40% ~ 50% å·¦å³æ¯”è¾ƒå¥½ã€‚
- ğŸ’¡ è°ƒå‚ç­–ç•¥ï¼š è‡ªé€‚åº” MCMC (Adaptive MCMC)ã€‚å…ˆè·‘ä¸€å°æ®µï¼Œå¦‚æœæ¥å—ç‡ $<10\%$ï¼Œå°±æŠŠ $\sigma$ å‡å°ï¼›å¦‚æœ $>60\%$ï¼Œå°±æŠŠ $\sigma$ å¢å¤§ã€‚

### å½¢çŠ¶ (Shape)ï¼šå°¾å·´è¯¥æœ‰å¤šé•¿ï¼Ÿ

é»˜è®¤æˆ‘ä»¬éƒ½ç”¨ **é«˜æ–¯åˆ†å¸ƒ (Normal Distribution)** ä½œä¸ºæ ¸ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªè‡´å‘½å¼±ç‚¹ï¼š**è½»å°¾ (Light-tailed)**ã€‚

é«˜æ–¯åˆ†å¸ƒçš„æ¦‚ç‡å¯†åº¦åœ¨è¿œç¦»ä¸­å¿ƒæ—¶ä¸‹é™å¾—æå¿«ï¼ˆæŒ‡æ•°çº§ä¸‹é™ï¼‰ã€‚è¿™æ„å‘³ç€å®ƒæåº¦åŒæ¶äº§ç”Ÿâ€œå¤§è·³è·ƒâ€ã€‚
- åœºæ™¯ï¼šåˆšæ‰çš„â€œåŒå³°â€é—®é¢˜ã€‚å¦‚æœä¸¤åº§å±±å³°éš”å¾—å¾ˆè¿œï¼ˆæ¯”å¦‚è·ç¦» $10\sigma$ï¼‰ï¼Œé«˜æ–¯æ ¸äº§ç”Ÿçš„æè®®å‡ ä¹æ°¸è¿œæ— æ³•è·¨è¶Šè¿™ä¸ªå³¡è°·ã€‚
- è§£æ³•ï¼šä½¿ç”¨ **æŸ¯è¥¿åˆ†å¸ƒ (Cauchy Distribution) æˆ– t-åˆ†å¸ƒ**ã€‚
  - åœ¨ python ä¸­å°±æ˜¯ `np.random.standard_cauchy`
  - æŸ¯è¥¿åˆ†å¸ƒçš„å¯†åº¦å‡½æ•°æ˜¯ $\frac{1}{1+x^2}$ï¼ˆå¤šé¡¹å¼çº§ä¸‹é™ï¼‰ï¼Œå®ƒçš„å°¾å·´éå¸¸â€œè‚¥â€ã€‚
  - æ•ˆæœï¼šå®ƒå¤§éƒ¨åˆ†æ—¶å€™è¿ˆå°æ­¥ï¼ˆå±€éƒ¨æœç´¢ï¼‰ï¼Œä½†å¶å°”ä¼šå‘ç–¯ä¼¼åœ°è¿ˆå‡ºå·¨å¤§çš„ä¸€æ­¥ï¼ˆå…¨å±€è·³è·ƒï¼‰ã€‚è¿™å¯¹äºè·³å‡ºå±€éƒ¨æœ€ä¼˜é™·é˜±æå…¶æœ‰æ•ˆã€‚

### æ–¹å‘ (Orientation)ï¼šå¦‚ä½•ç©¿è¶Šå³¡è°·ï¼Ÿ
å‡è®¾ç›®æ ‡åˆ†å¸ƒæ˜¯ä¸€ä¸ªç»†é•¿çš„æ¤­åœ†ï¼ˆä¸¤ä¸ªå˜é‡é«˜åº¦ç›¸å…³ï¼‰ï¼Œå°±åƒä¸€æ¡å€¾æ–œçš„å³¡è°·ã€‚
- è¿™ç§åˆ†å¸ƒçš„ç‰¹ç‚¹ï¼š
  - æ²¿ç€å³¡è°·æ–¹å‘ï¼ˆé•¿è½´ï¼‰ï¼šå˜åŒ–å¾ˆæ…¢ï¼Œåœ°åŠ¿å¹³å¦ã€‚
  - å‚ç›´å³¡è°·æ–¹å‘ï¼ˆçŸ­è½´ï¼‰ï¼šå˜åŒ–æå¿«ï¼Œç¨å¾®åä¸€ç‚¹å°±æ‰ä¸‹æ‚¬å´–ï¼ˆæ¦‚ç‡éª¤é™ï¼‰ã€‚
- å¦‚æœä½ ç”¨æ ‡å‡†çš„é«˜æ–¯æ ¸ (å„å‘åŒæ€§, Isotropic)ï¼š
  - ä½ çš„ $Q$ æ˜¯ä¸€ä¸ªæ­£åœ†ã€‚
  - å¦‚æœä½ æŠŠåœ†å¼„å¤§ï¼ˆä¸ºäº†æ²¿é•¿è½´èµ°å¾—å¿«ï¼‰ï¼Œä½ åœ¨çŸ­è½´æ–¹å‘å°±ä¼šé¢‘ç¹æ’å¢™ï¼ˆæ‰ä¸‹æ‚¬å´–ï¼‰ï¼Œå¯¼è‡´è¢«æ‹’ç»ã€‚
  - å¦‚æœä½ æŠŠåœ†å¼„å°ï¼ˆä¸ºäº†åœ¨çŸ­è½´æ–¹å‘å®‰å…¨ï¼‰ï¼Œä½ åœ¨é•¿è½´æ–¹å‘å°±èµ°ä¸åŠ¨äº†ã€‚
- è§£æ³•ï¼š**é¢„å¤„ç† (Preconditioning) æˆ– åæ–¹å·®çŸ©é˜µ (Covariance Matrix)**ã€‚
  - æˆ‘ä»¬å¸Œæœ› $Q$ çš„å½¢çŠ¶ä¹Ÿæ˜¯ä¸€ä¸ªå€¾æ–œçš„æ¤­åœ†ï¼Œå’Œç›®æ ‡åˆ†å¸ƒçš„æ–¹å‘ä¸€è‡´ã€‚
  - æ•°å­¦ä¸Šï¼Œè®¾ç›®æ ‡åæ–¹å·®ä¸º $\Sigma$ï¼Œæˆ‘ä»¬è®©æè®®åˆ†å¸ƒä¸º $q(\cdot|x) \sim N(x, c^2 \Sigma)$ã€‚
  - è¿™ç›¸å½“äºå…ˆæŠŠåæ ‡ç³»æ—‹è½¬ã€ç¼©æ”¾ï¼ŒæŠŠå³¡è°·å˜æˆæ­£åœ†ï¼Œç„¶åå†é‡‡æ ·ã€‚

# æ”¶æ•› (Convergence) å’Œ æ··åˆ (Mixing)

## ä»€ä¹ˆæ˜¯ Mixing (æ··åˆ)ï¼Ÿ
ç®€å•æ¥è¯´ï¼ŒMixing å°±æ˜¯é“¾æ¡â€œå¿˜æ‰â€å®ƒä»å“ªé‡Œå‡ºå‘ã€å¹¶å®Œå…¨èå…¥ç›®æ ‡åˆ†å¸ƒçš„é€Ÿåº¦ã€‚

æŠŠå®ƒæƒ³è±¡æˆå¾€å’–å•¡é‡Œå€’ç‰›å¥¶ï¼š
- åˆšå¼€å§‹ (æœªæ··åˆ)ï¼š ç‰›å¥¶åªåœ¨æ¯å­çš„ä¸€è§’ï¼Œæµ“åº¦æä¸å‡åŒ€ï¼ˆé“¾æ¡å—åˆå§‹å€¼å½±å“å¾ˆå¤§ï¼Œè¿˜åœ¨èµ¶è·¯ï¼‰ã€‚
- æ…æ‹Œä¸­ (æ··åˆæ…¢ - Slow Mixing)ï¼š ä½ ç”¨å¾ˆç»†çš„ç‰™ç­¾æ…¢æ…¢åˆ’æ‹‰ã€‚ç‰›å¥¶åœ¨æ‰©æ•£ï¼Œä½†å¾ˆæ…¢ã€‚ä½ éœ€è¦æ…å¾ˆä¹…ï¼Œæ¯å­å„å¤„çš„ç‰›å¥¶æµ“åº¦æ‰ä¸€æ ·ã€‚
- æ…æ‹Œå¥½ (æ··åˆå¿« - Fast Mixing)ï¼š ä½ ç”¨å¤§å‹ºå­çŒ›æ…å‡ ä¸‹ã€‚ç‰›å¥¶ç¬é—´å‡åŒ€åˆ†å¸ƒã€‚æ­¤æ—¶ä½ éšä¾¿èˆ€ä¸€å‹ºï¼Œéƒ½ä»£è¡¨äº†æ•´æ¯å’–å•¡çš„å¹³å‡çŠ¶æ€ã€‚

åœ¨ MCMC ä¸­ï¼š
- Good Mixing: æ— è®ºä½ æŠŠå°äººæ‰”åœ¨å“ªé‡Œï¼Œå®ƒèƒ½è¿…é€Ÿè·‘éæ•´ä¸ªåœ°å½¢ï¼ˆéå†æ€§ï¼‰ï¼Œä¸”ç¬¬ 100 æ­¥çš„ä½ç½®å’Œç¬¬ 1 æ­¥çš„ä½ç½®å‡ ä¹æ²¡æœ‰å…³ç³»ï¼ˆ**ç‹¬ç«‹æ€§**ï¼‰ã€‚
- Bad Mixing: å°äººè¦ä¹ˆè¢«å›°åœ¨æŸä¸ªå±±å¤´å‡ºä¸å»ï¼ˆStiffï¼‰ï¼Œè¦ä¹ˆèµ°å¾—å¤ªæ…¢ï¼ˆSmoothï¼‰ï¼Œå¯¼è‡´å®ƒé‡‡é›†çš„æ ·æœ¬ä¸¥é‡ä¾èµ–äºå®ƒåˆšæ‰æ‰€åœ¨çš„ä½ç½®ã€‚

> è¡¡é‡æ··åˆå¥½åçš„æœ€ä½³æ ‡å°ºå°±æ˜¯ **è‡ªç›¸å…³æ€§ (Autocorrelation)**ã€‚

## æ ¸å¿ƒåº¦é‡å·¥å…·ï¼šè‡ªç›¸å…³å‡½æ•° (ACF)
é¦–å…ˆï¼Œæˆ‘ä»¬è¦é‡åŒ–â€œå½“å‰è¿™ä¸€æ­¥ $X_t$ å’Œå®ƒä¹‹å‰çš„æŸä¸€æ­¥ $X_{t-k}$ åˆ°åº•æœ‰å¤šåƒâ€ã€‚è¿™å°±æ˜¯ **Autocorrelation Function (ACF)**ã€‚
- Lag $k$ (æ»å)ï¼šè¡¨ç¤ºç›¸éš” $k$ æ­¥ã€‚
- $\rho_k$ (è‡ªç›¸å…³ç³»æ•°)ï¼š
  - $\rho_k \approx 1$ï¼šå¼ºç›¸å…³ã€‚ä»Šå¤©çš„çŠ¶æ€å‡ ä¹å®Œå…¨ç”± $k$ å¤©å‰å†³å®šï¼ˆåäº‹ï¼Œè¯´æ˜æ²¡å¿˜æ‰è¿‡å»ï¼‰ã€‚
  - $\rho_k \approx 0$ï¼šæ— ç›¸å…³ã€‚ä»Šå¤©çš„çŠ¶æ€å’Œ $k$ å¤©å‰æ— å…³ï¼ˆå¥½äº‹ï¼Œè¯´æ˜æ˜¯ç‹¬ç«‹æ ·æœ¬ï¼‰ã€‚

æˆ‘ä»¬åœ¨è¯Šæ–­æ—¶ï¼Œä¼šç”»ä¸€å¼  ACF å›¾ï¼šæ¨ªè½´æ˜¯ $k$ï¼Œçºµè½´æ˜¯ $\rho_k$ã€‚æˆ‘ä»¬å¸Œæœ› $\rho_k$ åƒæ‚¬å´–ä¸€æ ·å¿«é€Ÿæ‰åˆ° 0ã€‚

### åœºæ™¯ A: The Smooth Chain (å¹³æ»‘é“¾ / æ­¥é•¿å¤ªå°)
> "Smooth $\to$ Long correlation"ã€‚

- ç°è±¡ï¼š æ­¥é•¿ $\sigma$ å¾ˆå°ï¼Œæ¥å—ç‡æé«˜ï¼ˆ$\approx 90\%$ï¼‰ã€‚
- è½¨è¿¹å›¾è¡¨ç°ï¼š çº¿æ¡è¿ç»­ã€åœ†æ»‘ï¼Œåƒä¸€æ¡èœ¿èœ’çš„é•¿è›‡ã€‚
- ç‰©ç†æœºåˆ¶ï¼ˆéšæœºæ¸¸èµ°ï¼‰ï¼š$$X_{t+1} = X_t + \epsilon \quad (\epsilon \text{ is tiny})$$è™½ç„¶æ¯ä¸€æ­¥éƒ½è¢«æ¥å—äº†ï¼Œä½† $X_{t+1}$ å’Œ $X_t$ é•¿å¾—å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚
- Correlation åˆ†æï¼š
  - ä½ è¦èŠ± 1000 æ­¥æ‰èƒ½ä»åˆ†å¸ƒçš„å·¦è¾¹èµ°åˆ°å³è¾¹ã€‚
  - è¿™æ„å‘³ç€ $X_{1000}$ ä¾ç„¶èƒ½åœ¨æŸç§ç¨‹åº¦ä¸Šé¢„æµ‹ $X_{1001}$ã€‚
  - ACF å›¾ï¼š $\rho_k$ ä¸‹é™ææ…¢ï¼ˆSlow decayï¼‰ã€‚å“ªæ€• $k=100$ï¼Œç›¸å…³æ€§å¯èƒ½è¿˜æœ‰ 0.8ã€‚ç»“è®ºï¼š 
- æ··åˆæå·® (Poor Mixing)ã€‚è™½ç„¶åœ¨åŠ¨ï¼Œä½†åŠ¨å¾—å¤ªå¢¨è¿¹ã€‚

### åœºæ™¯ B: The Stiff Chain (åƒµç¡¬é“¾ / æ­¥é•¿å¤ªå¤§)
é€šå¸¸â€œæ­¥é•¿æå¤§â€ä¼šå¯¼è‡´æ¥å—ç‡æä½ï¼ˆ$\approx 1\%$ï¼‰ã€‚
- ç°è±¡ï¼š æè®® $X_{new}$ æ€»æ˜¯è·³åˆ°å¾ˆè¿œçš„åœ°æ–¹ï¼ˆæ¦‚ç‡æä½åŒºï¼‰ï¼Œç„¶åè¢«æ‹’ç»ã€‚
- è½¨è¿¹å›¾è¡¨ç°ï¼š æ–¹æ³¢ (Square Wave)ã€‚é•¿æ—¶é—´æ˜¯ä¸€æ¡ç›´çº¿ï¼ˆåƒµç¡¬ã€å¡æ­»ï¼‰ï¼Œå¶å°”è·³å˜ä¸€ä¸‹ã€‚ç‰©ç†æœºåˆ¶ï¼ˆæ‹’ç»å³é‡å¤ï¼‰ï¼š$$X_{t+1} = X_t \quad (\text{å› ä¸ºæ‹’ç»})$$æ³¨æ„ï¼å½“æ‹’ç»å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è®°å½•æ—§å€¼ã€‚
- Correlation åˆ†æï¼š
  - ä½ ä»¥ä¸ºæ­¥å­å¤§ï¼Œæ ·æœ¬ä¹‹é—´å°±æ²¡å…³ç³»äº†å—ï¼Ÿ
  - é”™ï¼å› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´ä½ éƒ½åœ¨ **é‡å¤åŒä¸€ä¸ªæ•°å­—**ã€‚$X_t, X_{t+1}, \dots, X_{t+10}$ å…¨æ˜¯åŒä¸€ä¸ªæ•°å€¼ã€‚è¿™ä¸ä»…ä»…æ˜¯ç›¸å…³ï¼Œè¿™æ˜¯å®Œå…¨ç›¸åŒï¼
  - ACF å›¾ï¼š $\rho_k$ ä¾ç„¶å¾ˆé«˜ï¼Œç”šè‡³æ¯” Smooth çš„æƒ…å†µæ›´éš¾çœ‹ï¼Œå› ä¸ºå®ƒåŒ…å«é•¿æ®µçš„ $1.0$ ç›¸å…³æ€§ã€‚
- ç»“è®ºï¼š æ··åˆä¹Ÿæå·®ã€‚è¿™ç§â€œåƒµç¡¬â€å¯¼è‡´çš„çŸ­è§†ï¼ˆShort correlationï¼‰åªå­˜åœ¨äºâ€œæè®®â€é˜¶æ®µï¼Œä½†åœ¨â€œæ¥å—â€åçš„é“¾æ¡é‡Œï¼Œå®ƒæ˜¯å¼ºç›¸å…³çš„ã€‚

### é»„é‡‘å¹³è¡¡ï¼šæœ‰æ•ˆæ ·æœ¬é‡ (ESS)
æ—¢ç„¶â€œå¤ªé¡ºæ»‘â€ä¸è¡Œï¼ˆç›¸å…³æ€§é«˜ï¼‰ï¼Œâ€œå¤ªåƒµç¡¬â€ä¹Ÿä¸è¡Œï¼ˆé‡å¤ç‡é«˜ï¼Œç›¸å…³æ€§ä¹Ÿé«˜ï¼‰ã€‚æˆ‘ä»¬è¦è¿½æ±‚ä¸­é—´æ€ã€‚æˆ‘ä»¬ç”¨ä¸€ä¸ªæ ¸å¿ƒæŒ‡æ ‡æ¥ç»™é“¾æ¡æ‰“åˆ†ï¼š**æœ‰æ•ˆæ ·æœ¬é‡ (Effective Sample Size, ESS)**ã€‚

å‡è®¾ä½ è·‘äº† $N = 10,000$ æ­¥ã€‚
- å¦‚æœæ˜¯ Smooth é“¾ï¼š æ ·æœ¬é«˜åº¦ç›¸å…³ï¼Œè¿™ 1ä¸‡ä¸ªæ ·æœ¬åŒ…å«çš„ä¿¡æ¯é‡ï¼Œå¯èƒ½åªç›¸å½“äº 50 ä¸ª ç‹¬ç«‹æ ·æœ¬ã€‚
- å¦‚æœæ˜¯ Stiff é“¾ï¼š å¤§éƒ¨åˆ†æ ·æœ¬æ˜¯é‡å¤çš„ï¼Œä¿¡æ¯é‡å¯èƒ½åªç›¸å½“äº 10 ä¸ª ç‹¬ç«‹æ ·æœ¬ã€‚
- å¦‚æœæ˜¯ Optimal é“¾ï¼š 2-3 æ­¥å°±èƒ½å¿˜æ‰è¿‡å»ï¼Œä¿¡æ¯é‡å¯èƒ½ç›¸å½“äº 3,000 ä¸ª ç‹¬ç«‹æ ·æœ¬ã€‚å…¬å¼ï¼š$$N_{eff} = \frac{N}{1 + 2 \sum_{k=1}^{\infty} \rho_k}$$ï¼ˆåˆ†æ¯å°±æ˜¯ Integrated Autocorrelation Time, $\tau$ï¼Œä¹Ÿå°±æ˜¯â€œäº§ç”Ÿä¸€ä¸ªç‹¬ç«‹æ ·æœ¬å¹³å‡éœ€è¦å¤šå°‘æ­¥â€ï¼‰

### ç›¸å…³æ€§çš„ U å‹æ›²çº¿

å¦‚æœæˆ‘ä»¬å°† æ­¥é•¿ (Step Size $\sigma$) ä½œä¸ºæ¨ªè½´ï¼Œè‡ªç›¸å…³æ—¶é—´ ($\tau$) ä½œä¸ºçºµè½´ï¼Œä¼šå¾—åˆ°ä¸€æ¡ U å‹æ›²çº¿ã€‚
- å·¦ä¾§ (Small $\sigma$)ï¼š Smoothã€‚æ¥å—ç‡é«˜ï¼Œä½†å•æ­¥ä½ç§»å°ã€‚$\tau$ å¾ˆé«˜ï¼ˆæ…¢ï¼‰ã€‚
- å³ä¾§ (Large $\sigma$)ï¼š Stiffã€‚å•æ­¥ä½ç§»å¤§ï¼Œä½†æ¥å—ç‡ä½ï¼ˆè€æ˜¯è¢«æ‹’ï¼Œè€æ˜¯é‡å¤ï¼‰ã€‚$\tau$ å¾ˆé«˜ï¼ˆæ…¢ï¼‰ã€‚
- è°·åº• (Optimal $\sigma$)ï¼š Sweet Spotã€‚
  - æ¥å—ç‡æ§åˆ¶åœ¨ 23.4% (é«˜ç»´) æˆ– 40-50% (1ç»´)ã€‚
  - ACF åƒç€‘å¸ƒä¸€æ ·è¿…é€Ÿæ‰åˆ° 0ã€‚
  - è¿™å°±æ˜¯æ‰€è°“çš„ "Good Mixing"ã€‚

### ç¤ºä¾‹ï¼šä¸‰å¼  ACF å›¾

ç”¨ Python æ¨¡æ‹Ÿä¸€ä¸ªç®€å•çš„ æ ‡å‡†æ­£æ€åˆ†å¸ƒé‡‡æ ·ï¼Œå¹¶ç”»å‡ºSmooth (æ­¥é•¿å°) vs Stiff (æ­¥é•¿å¾ˆå¤§) vs Optimal (æ­¥é•¿é€‚ä¸­)çš„ è½¨è¿¹å›¾ (Trace Plot) å’Œ è‡ªç›¸å…³å›¾ (ACF Plot)ã€‚


```python
import numpy as np
import matplotlib.pyplot as plt
import statsmodels.api as sm

# --- 1. å‡†å¤‡å·¥ä½œ ---
# ç›®æ ‡ï¼šæ ‡å‡†æ­£æ€åˆ†å¸ƒ N(0, 1)
def target_log_prob(x):
    return -0.5 * x**2

# Metropolis é‡‡æ ·æ ¸
def run_chain(n_steps, step_size, start_x=0.0):
    samples = np.zeros(n_steps)
    current_x = start_x
    accepted = 0
    
    for i in range(n_steps):
        # æè®®
        proposal = current_x + np.random.normal(0, step_size)
        
        # æ¥å—ç‡ (Log scale for stability)
        log_alpha = target_log_prob(proposal) - target_log_prob(current_x)
        # min(1, A) -> min(0, log_A) in log domain
        if np.log(np.random.rand()) < log_alpha:
            current_x = proposal
            accepted += 1
            
        samples[i] = current_x
        
    acc_rate = accepted / n_steps
    return samples, acc_rate

# --- 2. è¿è¡Œä¸‰ç§åœºæ™¯ ---
N = 2000
# A. Smooth (æ­¥é•¿å¤ªå°)
chain_smooth, acc_smooth = run_chain(N, step_size=0.1)
# B. Stiff (æ­¥é•¿å¤ªå¤§)
chain_stiff, acc_stiff = run_chain(N, step_size=50.0)
# C. Optimal (æ­¥é•¿é€‚ä¸­)
chain_optimal, acc_optimal = run_chain(N, step_size=2.4) # å¯¹äº1ç»´é«˜æ–¯ï¼Œå¤§ä¸€ç‚¹æ²¡äº‹

# --- 3. ç»˜å›¾å¯¹æ¯” (Trace + ACF) ---
fig, axes = plt.subplots(3, 2, figsize=(14, 10))
lags = 100 # çœ‹å‰100æ­¥çš„ç›¸å…³æ€§

# è¾…åŠ©å‡½æ•°ï¼šç”»ä¸€è¡Œå›¾
def plot_row(row_idx, samples, acc, title, color):
    # å·¦è¾¹ï¼šTrace Plot
    ax_trace = axes[row_idx, 0]
    ax_trace.plot(samples, color=color, lw=1)
    ax_trace.set_title(f"{title} - Trace (Acc: {acc:.1%})")
    ax_trace.set_ylabel("Value")
    
    # å³è¾¹ï¼šACF Plot
    ax_acf = axes[row_idx, 1]
    # ä½¿ç”¨ statsmodels è®¡ç®— ACF
    acf_values = sm.tsa.acf(samples, nlags=lags)
    ax_acf.bar(range(len(acf_values)), acf_values, width=0.3, color=color, alpha=0.7)
    ax_acf.set_title(f"{title} - Autocorrelation")
    ax_acf.set_ylim(-0.1, 1.1)
    ax_acf.set_ylabel("Correlation")
    ax_acf.axhline(0.05, linestyle='--', color='gray', alpha=0.5) # æ˜¾è‘—æ€§é˜ˆå€¼
    ax_acf.axhline(0, color='black', lw=1)

# ç»˜åˆ¶ä¸‰è¡Œ
plot_row(0, chain_smooth, acc_smooth, "A. Smooth (Step=0.1)", "orange")
plot_row(1, chain_stiff, acc_stiff, "B. Stiff (Step=50)", "purple")
plot_row(2, chain_optimal, acc_optimal, "C. Optimal (Step=2.4)", "green")

plt.tight_layout()
plt.show()
```


    
![png](/img/contents/post/mcmc-statics/6_metropolis/6_mcmc_metropolis_14_0.png)
    


**A. Smooth (æ©™è‰²) â€”â€” æ­¥é•¿å¤ªå°**
- Trace (å·¦): åƒä¸€æ¡èœ¿èœ’çš„è›‡ï¼Œçˆ¬å¾—å¾ˆæ…¢ã€‚
- ACF (å³): é•¿é•¿çš„æ‹–å°¾ (Slow Decay)ã€‚
  - å³ä½¿åˆ°äº† Lag=100ï¼ˆç›¸éš”100æ­¥ï¼‰ï¼Œç›¸å…³æ€§å¯èƒ½è¿˜æœ‰ 0.8 æˆ– 0.9ã€‚
  - å«ä¹‰ï¼š â€œæˆ‘è®°å¾—æˆ‘ç¥–å®—åå…«ä»£çš„æ ·è²Œâ€ã€‚ç¬¬ 100 æ­¥çš„çŠ¶æ€ä¾ç„¶å¼ºçƒˆä¾èµ–äºç¬¬ 1 æ­¥ã€‚è¿™æ„å‘³ç€è™½ç„¶ä½ è·‘äº† 2000 æ­¥ï¼Œä½†æœ‰æ•ˆæ ·æœ¬é‡ï¼ˆç‹¬ç«‹æ ·æœ¬ï¼‰å¯èƒ½åªæœ‰å‡ åä¸ªã€‚Mixing å¾ˆå·®ã€‚

**B. Stiff (ç´«è‰²) â€”â€” æ­¥é•¿å¤ªå¤§**
- Trace (å·¦): æ–¹æ³¢/å¿ƒç”µå›¾ã€‚é•¿æ—¶é—´å¡åœ¨ä¸€ä¸ªå€¼ä¸åŠ¨ï¼ˆæ‹’ç»ï¼‰ï¼Œå¶å°”è·³ä¸€ä¸‹ã€‚
- ACF (å³): åŒæ ·æ˜¯é•¿æ‹–å°¾ï¼Œç”šè‡³æ›´ä¸¥é‡ã€‚
  - ä½ ä¼šå‘ç°ç›¸å…³æ€§å¹¶ä¸æ˜¯åƒ Smooth é‚£æ ·å¹³æ»‘ä¸‹é™ï¼Œè€Œæ˜¯å¯èƒ½åœ¨ä¸€å¤§æ®µ Lag å†…éƒ½ç»´æŒåœ¨å¾ˆé«˜æ°´å¹³ï¼ˆå› ä¸ºæ•°å€¼æ ¹æœ¬æ²¡å˜ï¼Œç›¸å…³æ€§å½“ç„¶æ˜¯ 1.0ï¼‰ã€‚
  - å«ä¹‰ï¼š â€œæˆ‘ä¸ä»…è®°å¾—è¿‡å»ï¼Œæˆ‘ç®€ç›´å°±æ˜¯è¿‡å»çš„å¤åˆ¶å“â€ã€‚ç”±äºå¤§é‡é‡å¤å€¼ï¼Œä¿¡æ¯é‡æä½ã€‚Mixing ä¹Ÿå¾ˆå·®ã€‚

**C. Optimal (ç»¿è‰²) â€”â€” é»„é‡‘æ­¥é•¿**
- Trace (å·¦): æ¯›æ¯›è™«ã€‚å›´ç»• 0 å‰§çƒˆéœ‡è¡ï¼Œçœ‹ä¸å‡ºè¶‹åŠ¿ã€‚
- ACF (å³): æ–­**å´–å¼ä¸‹è·Œ (Fast Decay)**ã€‚
  - Lag=0 æ—¶æ˜¯ 1.0ï¼ˆè‡ªå·±è·Ÿè‡ªå·±è‚¯å®šç›¸å…³ï¼‰ã€‚
  - Lag=5 æˆ– 10 å·¦å³ï¼ŒæŸ±å­å°±è¿…é€Ÿæ‰åˆ°äº† 0 é™„è¿‘ï¼ˆè™šçº¿åŒºåŸŸï¼‰ã€‚
  - å«ä¹‰ï¼š â€œå¥½æ±‰ä¸æå½“å¹´å‹‡â€ã€‚ä»…ä»…èµ°äº†å‡ æ­¥ï¼Œé“¾æ¡å°±å®Œå…¨å¿˜è®°äº†åˆšæ‰åœ¨å“ªé‡Œã€‚è¿™è¯´æ˜æ¯éš”å‡ æ­¥æˆ‘ä»¬å°±èƒ½è·å¾—ä¸€ä¸ªå…¨æ–°çš„ã€ç‹¬ç«‹çš„æœ‰æ•ˆæ ·æœ¬ã€‚è¿™å°±æ˜¯ Perfect Mixingï¼

# Burn-inï¼ˆé¢„çƒ­ / è€åŒ–ï¼‰

**Burn-in æŒ‡çš„æ˜¯åœ¨ MCMC é‡‡æ ·å¼€å§‹åï¼Œæˆ‘ä»¬è¦ç›´æ¥ä¸¢å¼ƒæ‰çš„å‰é¢ $N$ ä¸ªæ ·æœ¬ã€‚**

æ¯”å¦‚ä½ è®©ç¨‹åºè·‘äº† 10,000 æ­¥ï¼Œä½†ä½ å¯èƒ½åªä¿ç•™ç¬¬ 1,001 æ­¥åˆ°ç¬¬ 10,000 æ­¥çš„æ•°æ®ã€‚å‰ 1,000 ä¸ªæ ·æœ¬å°±æ˜¯ Burn-in æœŸï¼Œç›´æ¥æ‰”è¿›åƒåœ¾æ¡¶ã€‚ğŸ—‘ï¸

## ä¸ºä»€ä¹ˆè¦æ‰”æ‰å®ƒä»¬ï¼Ÿ(The Bias Problem)

å› ä¸º MCMC ç®—æ³•æœ‰ä¸€ä¸ª **â€œåˆå§‹åŒ–åè§â€ (Initialization Bias)** çš„é—®é¢˜ã€‚

æƒ³è±¡ä½ è¦ç»Ÿè®¡ä¸€ä¸ªä¸‡äººä½“è‚²é¦†é‡Œè§‚ä¼—çš„å¹³å‡èº«é«˜ï¼š
1. éšæœºç©ºé™ï¼š ä½ ä¸å¯èƒ½ç›´æ¥ç©ºé™åˆ°äººæœ€å¯†é›†çš„åœ°æ–¹ã€‚ç¨‹åºåˆå§‹åŒ–æ—¶ï¼Œé€šå¸¸æ˜¯éšæœºçŒœä¸€ä¸ªèµ·ç‚¹ï¼ˆæ¯”å¦‚ $x_0 = 100$ï¼‰ã€‚
2. çˆ¬å±±èµ¶è·¯ï¼š å‡è®¾ç›®æ ‡åˆ†å¸ƒï¼ˆå¤§éƒ¨åˆ†äººï¼‰éƒ½åœ¨ $x=0$ é™„è¿‘ã€‚ä½ çš„é‡‡æ ·å™¨ä»å°äººä» $x=100$ å‡ºå‘ï¼Œå®ƒéœ€è¦ä¸€æ­¥ä¸€æ­¥â€œçˆ¬â€åˆ° $x=0$ çš„åŒºåŸŸã€‚
3. åƒåœ¾æ—¶é—´ï¼š åœ¨å®ƒä» 100 èµ°åˆ° 0 çš„è¿™æ®µè·¯ç¨‹ä¸­ï¼Œå®ƒè®°å½•çš„æ ·æœ¬æ˜¯ï¼š99, 98, ..., 50, ..., 10, ...ã€‚
   - é—®é¢˜æ¥äº†ï¼š è¿™äº›æ•°å€¼æ ¹æœ¬ä¸å±äºç›®æ ‡åˆ†å¸ƒï¼ˆ$N(0,1)$ï¼‰ï¼å®ƒä»¬åªæ˜¯å°äººâ€œèµ¶è·¯â€ç•™ä¸‹çš„è„šå°ã€‚
   - åæœï¼š å¦‚æœä½ æŠŠè¿™äº›èµ¶è·¯çš„æ•°æ®ç®—è¿›å¹³å‡å€¼ï¼Œä½ çš„ç»“æœå°±ä¼šè¢«ä¸¥é‡æ‹‰é«˜ï¼ˆåç¦»çœŸå®å€¼ï¼‰ã€‚

Burn-in çš„ä½œç”¨å°±æ˜¯ï¼š ç­‰å°äººçœŸæ­£èµ°åˆ°äº†ä½“è‚²é¦†ä¸­å¿ƒï¼ˆè¿›å…¥äº†å¹³ç¨³åˆ†å¸ƒ Stationary Distributionï¼‰ï¼Œæˆ‘ä»¬æ‰å¼€å§‹æŒ‰ä¸‹å½•åƒé”®ã€‚ä¹‹å‰çš„èµ¶è·¯è¿‡ç¨‹ç»Ÿç»Ÿå‰ªæ‰ã€‚

## Python è§†è§‰å®æˆ˜ï¼šçœ‹è§ Burn-in

æ¨¡æ‹Ÿä¸€ä¸ªæ ‡å‡†æ­£æ€åˆ†å¸ƒï¼ˆä¸­å¿ƒåœ¨ 0ï¼‰ï¼Œä½†æˆ‘ä»¬å°†èµ·ç‚¹æ•…æ„è®¾åœ¨æè¿œçš„åœ°æ–¹ ($x=20$)ï¼Œå¹¶ä¸”è®©æ­¥é•¿ç¨å¾®å°ä¸€ç‚¹ï¼ˆæ¨¡æ‹Ÿèµ°å¾—æ…¢çš„æƒ…å†µï¼‰ã€‚


```python
import numpy as np
import matplotlib.pyplot as plt

# 1. ç›®æ ‡ï¼šæ ‡å‡†æ­£æ€åˆ†å¸ƒ N(0, 1)
def target_log_prob(x):
    return -0.5 * x**2

# 2. æ¨¡æ‹Ÿé‡‡æ ·
def run_burnin_demo(n_steps, start_x, step_size):
    samples = np.zeros(n_steps)
    current_x = start_x
    
    for i in range(n_steps):
        # æè®®
        proposal = current_x + np.random.normal(0, step_size)
        # æ¥å—ç‡
        log_alpha = target_log_prob(proposal) - target_log_prob(current_x)
        if np.log(np.random.rand()) < log_alpha:
            current_x = proposal
        samples[i] = current_x
        
    return samples

# --- è®¾ç½® ---
N = 1000
start_val = 20.0  # <--- èµ·ç‚¹ç¦»ä¸­å¿ƒ(0)éå¸¸è¿œï¼
step = 0.5        # æ­¥é•¿è¾ƒå°ï¼Œèµ°å¾—æ…¢

chain = run_burnin_demo(N, start_val, step)

# --- ç»˜å›¾ ---
plt.figure(figsize=(12, 6))

# ç”»å‡ºè½¨è¿¹
plt.plot(chain, label='MCMC Chain', color='blue', lw=1.5)

# æ ‡å‡º Burn-in çš„åˆ†ç•Œçº¿ (æ¯”å¦‚å¤§çº¦åœ¨ç¬¬ 200 æ­¥åˆ°è¾¾ä¸­å¿ƒ)
burn_in_cutoff = 200
plt.axvline(x=burn_in_cutoff, color='red', linestyle='--', lw=2, label='Burn-in Cutoff')

# æ ‡æ³¨æ–‡å­—
plt.text(50, 15, "Transient Phase\n(Garbage Samples)", color='red', fontsize=12, fontweight='bold')
plt.text(400, 5, "Stationary Phase\n(Valid Samples)", color='green', fontsize=12, fontweight='bold')

plt.title(f"Visualizing Burn-in: Starting from x={start_val} to target N(0,1)")
plt.xlabel("Iteration")
plt.ylabel("Sample Value")
plt.axhline(0, color='gray', linestyle=':', alpha=0.5) # ç›®æ ‡å‡å€¼
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```


    
![png](/img/contents/post/mcmc-statics/6_metropolis/6_mcmc_metropolis_17_0.png)
    


è§‚å¯Ÿé‚£æ¡è“çº¿ï¼š
- å·¦ä¾§ï¼ˆçº¢çº¿å·¦è¾¹ï¼‰ï¼š
   - ä¸‹å¡è·¯å°äººä» 20 å¼€å§‹ï¼Œä¸€è·¯è·Œè·Œæ’æ’å¾€ä¸‹æ‰ã€‚
   - è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼ˆæ¯”å¦‚ 18, 15, 8...ï¼‰å…¨æ˜¯åƒåœ¾ã€‚å®ƒä»¬åªåæ˜ äº†ä½ çš„åˆå§‹å€¼è®¾å¾—æœ‰å¤šåï¼Œå®Œå…¨ä¸ä»£è¡¨ $N(0,1)$ åˆ†å¸ƒã€‚
   - è¿™å°±æ˜¯ **Burn-in Period**ã€‚
- å³ä¾§ï¼ˆçº¢çº¿å³è¾¹ï¼‰ï¼š
  - æ¯›æ¯›è™«å¤§çº¦åœ¨ç¬¬ 200 æ­¥å·¦å³ï¼Œå°äººç»ˆäºåˆ°è¾¾äº† 0 é™„è¿‘ã€‚
  - ä¹‹åçš„è½¨è¿¹å¼€å§‹å›´ç»• 0 ä¸Šä¸‹éœ‡è¡ï¼Œçœ‹ä¸å‡ºä»»ä½•è¶‹åŠ¿ã€‚
  - è¿™æ—¶å€™ï¼Œé“¾æ¡æ‰çœŸæ­£ **æ”¶æ•›ï¼ˆConvergedï¼‰**åˆ°äº†ç›®æ ‡åˆ†å¸ƒã€‚è¿™ä¹‹åçš„æ•°æ®æ‰æ˜¯æˆ‘ä»¬èƒ½ç”¨çš„ã€‚

## Burn-in è¦è®¾å¤šé•¿ï¼Ÿ
è¿™æ˜¯ MCMC è°ƒå‚ä¸­æœ€ç„å­¦çš„é—®é¢˜ä¹‹ä¸€ã€‚
- **çœ‹å›¾æ³•**ï¼ˆæœ€å¸¸ç”¨ï¼‰ï¼š ç”»å‡º Trace Plotï¼ˆå°±åƒä¸Šé¢é‚£æ ·ï¼‰ã€‚è‚‰çœ¼è§‚å¯Ÿæ›²çº¿ä»€ä¹ˆæ—¶å€™ä¸å†æœ‰æ˜æ˜¾çš„ä¸Šå‡æˆ–ä¸‹é™è¶‹åŠ¿ï¼Œå¼€å§‹å˜å¾—åƒæ¯›æ¯›è™«ä¸€æ ·å¹³ç¨³éœ‡è¡ã€‚
- ä¿å®ˆæ³•ï¼š **ç›´æ¥æ‰”æ‰å‰ 50% çš„æ ·æœ¬**ã€‚åæ­£ç°åœ¨çš„ç”µè„‘ç®—åŠ›ä¾¿å®œï¼Œå¤šæ‰”ç‚¹ä¸å¿ƒç–¼ï¼Œæ€»æ¯”ä¿ç•™äº†åƒåœ¾æ•°æ®å¼ºã€‚
- å…³è”ä¹‹å‰çš„çŸ¥è¯†ï¼š
  - å¦‚æœæ­¥é•¿å¤ªå°ï¼ˆSmooth Chainï¼‰ï¼Œå°äººèµ°å¾—æ…¢ï¼Œä» 20 èµ°åˆ° 0 éœ€è¦å¾ˆä¹… $\to$ éœ€è¦å¾ˆé•¿çš„ Burn-inã€‚
  - å¦‚æœæ··åˆå¾—å¥½ï¼ˆOptimal Chainï¼‰ï¼Œå°äººå‡ æ­¥å°±è·³è¿‡å»äº† $\to$ åªéœ€è¦å¾ˆçŸ­çš„ Burn-inã€‚


